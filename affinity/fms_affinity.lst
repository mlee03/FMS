Page 1           Source Listing                  FMS_AFFINITY_INIT
2021-06-01 08:54                                 /tmp/ifortrahm6J.i90

      1 # 1 "fms_affinity.F90"
      2 !***********************************************************************
      3 !*                   GNU Lesser General Public License
      4 !*
      5 !* This file is part of the GFDL Flexible Modeling System (FMS).
      6 !*
      7 !* FMS is free software: you can redistribute it and/or modify it under
      8 !* the terms of the GNU Lesser General Public License as published by
      9 !* the Free Software Foundation, either version 3 of the License, or (at
     10 !* your option) any later version.
     11 !*
     12 !* FMS is distributed in the hope that it will be useful, but WITHOUT
     13 !* ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
     14 !* FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
     15 !* for more details.
     16 !*
     17 !* You should have received a copy of the GNU Lesser General Public
     18 !* License along with FMS.  If not, see <http://www.gnu.org/licenses/>.
     19 !***********************************************************************
     20 
     21 !> @file
     22 !! @brief Fortran API interfaces to set the thread affinity.
     23 !! @author Rusty Benson
     24 !! @email gfdl.climate.model.info@noaa.gov
     25 !!
     26 !! API interfaces to allow setting and getting thread affinity.  The thread affinity get and set
     27 !! are managed in the C routines in affinity.c.
     28 module fms_affinity_mod
     29 
     30 !--- standard system modules
     31   use, intrinsic :: iso_c_binding, only: c_int, c_bool
     32   use omp_lib
     33 
     34 !--- FMS modules
     35   use mpp_mod,    only: input_nml_file, mpp_pe, stdlog
     36   use fms_mod,    only: fms_init, check_nml_error, write_version_number, &
     37                         error_mesg, FATAL, NOTE
     38 
     39 !--- default scoping
     40   implicit none
     41   private
     42 
     43   interface
     44     integer(KIND=c_int) function fms_affinity_get() bind(c, name="get_cpu_affinity")
     45       import c_int
     46     end function fms_affinity_get
     47 
     48     integer(KIND=c_int) function get_cpuset(fsz, output, pe, debug) bind(c, name="get_cpuset")
     49       import c_int, c_bool
     50       integer(KIND=c_int), value, intent(in) :: fsz, pe
     51       integer(KIND=c_int), dimension(*), intent(inout) :: output
     52       logical(KIND=c_bool), value :: debug
     53     end function get_cpuset
     54 
     55     integer(KIND=c_int) function set_cpu_affinity(cpu) bind(c, name="set_cpu_affinity")
     56       import c_int
     57       integer(KIND=c_int), value, intent(in) :: cpu

Page 2           Source Listing                  FMS_AFFINITY_INIT
2021-06-01 08:54                                 fms_affinity.F90

     58     end function set_cpu_affinity
     59   end interface
     60 
     61 !--- namelist parameters
     62   logical:: affinity = .true.
     63   logical:: strict = .true.
     64   logical:: debug_affinity = .false.
     65   logical(c_bool):: debug_cpuset = .false.
     66   namelist /fms_affinity_nml/ affinity, strict, debug_affinity, debug_cpuset
     67 
     68   public fms_affinity_init, fms_affinity_get, fms_affinity_set
     69 
     70 !---- version number
     71 ! Include variable "version" to be written to log file.
     72 # 1 "../include/file_version.h" 1 
     73 ! -*-f90-*-
     74 !***********************************************************************
     75 !*                   GNU Lesser General Public License
     76 !*
     77 !* This file is part of the GFDL Flexible Modeling System (FMS).
     78 !*
     79 !* FMS is free software: you can redistribute it and/or modify it under
     80 !* the terms of the GNU Lesser General Public License as published by
     81 !* the Free Software Foundation, either version 3 of the License, or (at
     82 !* your option) any later version.
     83 !*
     84 !* FMS is distributed in the hope that it will be useful, but WITHOUT
     85 !* ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
     86 !* FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
     87 !* for more details.
     88 !*
     89 !* You should have received a copy of the GNU Lesser General Public
     90 !* License along with FMS.  If not, see <http://www.gnu.org/licenses/>.
     91 !***********************************************************************
     92 
     93 # 23
     94 
     95   character(len=*), parameter :: version = 'unknown'
     96 
     97 # 72 "fms_affinity.F90" 2 
     98 
     99   logical :: module_is_initialized = .FALSE.
    100 
    101 contains
    102 
    103 !> @brief initialization routine for affinity handling
    104   subroutine fms_affinity_init()
    105 !--- local variables
    106     integer:: io_stat
    107     integer:: ierr
    108     integer:: unit
    109 
    110 !--- return if module is initialized
    111     if (module_is_initialized) return
    112 
    113 !--- ensure fms/mpp has been initialized
    114     call fms_init()

Page 3           Source Listing                  FMS_AFFINITY_INIT
2021-06-01 08:54                                 fms_affinity.F90

    115 
    116 !--- read in namelist
    117     read(input_nml_file, fms_affinity_nml, iostat=io_stat)
    118     ierr = check_nml_error(io_stat,'fms_affinity_nml')
    119 
    120 !--- output information to logfile
    121     call write_version_number("fms_affinity_mod", version)
    122     unit = stdlog()
    123     write(unit,nml=fms_affinity_nml)
    124 
    125     module_is_initialized = .TRUE.
    126 
    127   end subroutine fms_affinity_init


ENTRY POINTS

  Name                                              
                                                    
 fms_affinity_mod_mp_fms_affinity_init_             


SYMBOL CROSS REFERENCE

 Name                       Object Declared Type            Bytes Dimen Elements Attributes       References                        
                                                                                                                                    
 CHECK_NML_ERROR            Func   118      I(4)            4           scalar   PRIV             36,118                            
 FMS_AFFINITY_INIT          Subr   104                                                                                              
 FMS_AFFINITY_NML           Local  117                                  scalar                    117,123                           
 FMS_INIT                   Subr   114                                           PRIV             36,114                            
 IERR                       Local  107      I(4)            4           scalar                    118                               
 INPUT_NML_FILE             Local  117      CHAR                  1     1        ALC,TGT,PRIV     35,117                            
 IO_STAT                    Local  106      I(4)            4           scalar                    117,118                           
 MODULE_IS_INITIALIZED      Local  111      L(4)            4           scalar                    99,111,125                        
 STDLOG                     Func   122      I(4)            4           scalar   PRIV             35,122                            
 UNIT                       Local  108      I(4)            4           scalar                    122,123                           
 VERSION                    Param  121      CHAR            7           scalar                    121                               
 WRITE_VERSION_NUMBER       Subr   121                                           PRIV             36,121                            

Page 4           Source Listing                  FMS_AFFINITY_INIT
2021-06-01 08:54                                 fms_affinity.F90

    128 
    129 
    130 !> @brief routine to set affinity
    131   subroutine fms_affinity_set (component, use_hyper_thread, nthreads)
    132 !--- interface variables
    133     character(len=*),  intent(in):: component !< Component name
    134     logical,           intent(in):: use_hyper_thread !< .TRUE. if using hyperthreads
    135     integer,           intent(in):: nthreads !< Number of threads
    136 
    137 !--- local declarations for Fortran/C affinity interoperability
    138     integer(c_int):: cpuset_sz
    139     integer(c_int), dimension(:), allocatable:: cpu_set
    140     integer(c_int):: retcode
    141 
    142 !--- local variables
    143     character(len=32):: h_name
    144     integer:: MSG_TYPE
    145     integer:: th_num
    146     integer:: indx
    147 
    148     if (.not. affinity) return
    149 
    150     if (strict) then
    151       MSG_TYPE = FATAL
    152     else
    153       MSG_TYPE = NOTE
    154     endif
    155 
    156     h_name = 'generic                         '
    157 
    158 !--- allocate storage for cpuset
    159     if (use_hyper_thread) then
    160       cpuset_sz = nthreads
    161     else
    162       cpuset_sz = nthreads * 2
    163     endif
    164     allocate (cpu_set(0:cpuset_sz-1))
    165 
    166 !--- get cpuset for this MPI-rank
    167     retcode = get_cpuset(cpuset_sz, cpu_set, mpp_pe(), debug_cpuset)
    168     if (retcode == -1) then
    169       call error_mesg('fms_affinity_set',trim(component)//' cpu_set size > allocated storage',FATAL)
    170     elseif ( (retcode == cpuset_sz/2) .and. (retcode == nthreads) ) then
    171       call error_mesg('fms_affinity_set',trim(component)//' affinity assumes hyper-threading hardware disabled',NOTE)
    172     elseif (retcode < cpuset_sz) then
    173       call error_mesg('fms_affinity_set',trim(component)//' cpu_set size smaller than expected',MSG_TYPE)
    174     endif
    175 
    176 !--- set the affinity for the MPI-rank
    177     retcode = set_cpu_affinity(cpu_set(0))
    178     if (retcode == -1) then
    179       call error_mesg('fms_affinity_set',trim(component)//': issue setting cpu affinity', FATAL)
    180     endif
    181 
    182 !--- set affinity for threads associated with this MPI-rank
    183 !$OMP PARALLEL NUM_THREADS (nthreads) &
    184 !$OMP&         DEFAULT (none) &

Page 5           Source Listing                  FMS_AFFINITY_SET
2021-06-01 08:54                                 fms_affinity.F90

    185 !$OMP&         SHARED (use_hyper_thread, cpuset_sz, component, cpu_set, debug_affinity) &
    186 !$OMP&         PRIVATE (th_num, indx, retcode, h_name)
    187 !$  th_num = omp_get_thread_num()
    188 !--- handle hyper threading case by alternating threads between logical and virtual cores
    189 !$  if (use_hyper_thread) then
    190 !$    if (mod(th_num,2) == 0 ) then
    191 !$      indx = th_num/2
    192 !$    else
    193 !$      indx = (cpuset_sz - 1) - ((cpuset_sz - 1) - th_num)/2
    194 !$    endif
    195 !$  else
    196 !$    indx = th_num
    197 !$  endif
    198 !$  retcode = set_cpu_affinity(cpu_set(indx))
    199 !$  if (retcode == -1) then
    200 !$    call error_mesg('fms_affinity_set',trim(component)//': issue setting cpu affinity', FATAL)
    201 !$  endif
    202 !--- output affinity placement
    203 !$  if (debug_affinity) then
    204 !$    call hostnm(h_name)
    205 !$    print *, 'DEBUG:',mpp_pe(),trim(component),' ',trim(h_name),fms_affinity_get(),th_num
    206 !$  endif
    207 !$OMP END PARALLEL
    208 
    209   end subroutine fms_affinity_set


ENTRY POINTS

  Name                                             
                                                   
 fms_affinity_mod_mp_fms_affinity_set_             

Page 6           Source Listing                  FMS_AFFINITY_SET
2021-06-01 08:54 Symbol Table                    fms_affinity.F90



SYMBOL CROSS REFERENCE

 Name                       Object Declared Type            Bytes Dimen Elements Attributes       References                        
                                                                                                                                    
 AFFINITY                   Local  148      L(4)            4           scalar                    62,66,148                         
 COMPONENT                  Dummy  131      CHAR                        scalar   ARG,IN           169,171,173,179,185,200,205       
 CPUSET_SZ                  Local  138      I(4)            4           scalar                    160,162,164,167,170,172,185,193   
 CPU_SET                    Local  139      I(4)            4     1     1        ALC              164,167,177,185,198               
 DEBUG_AFFINITY             Local  185      L(4)            4           scalar                    64,66,185,203                     
 DEBUG_CPUSET               Local  167      L(1)            1           scalar                    65,66,167                         
 ERROR_MESG                 Subr   169                                           PRIV             37,169,171,173,179,200            
 FATAL                      Param  151      I(4)            4           scalar   PRIV             37,151,169,179,200                
 FMS_AFFINITY_GET           Func   205      I(4)            4           scalar                    68,205                            
 FMS_AFFINITY_SET           Subr   131                                                                                              
 HOSTNM                     Subr   204                                                            204                               
 H_NAME                     Local  143      CHAR            32          scalar                    156,186,204,205                   
 INDX                       Local  146      I(4)            4           scalar                    186,191,193,196,198               
 MOD                        Func   190                                  scalar                    190                               
 MPP_PE                     Func   167      I(4)            4           scalar   PRIV             35,167,205                        
 MSG_TYPE                   Local  144      I(4)            4           scalar                    151,153,173                       
 NOTE                       Param  153      I(4)            4           scalar   PRIV             37,153,171                        
 NTHREADS                   Dummy  131      I(4)            4           scalar   ARG,IN           160,162,170,183                   
 OMP_GET_THREAD_NUM         Func   187      I(4)            4           scalar   PRIV             187                               
 RETCODE                    Local  140      I(4)            4           scalar                    167,168,170,172,177,178,186,198,19
                                                                                                  9                                 
 STRICT                     Local  150      L(4)            4           scalar                    63,66,150                         
 TH_NUM                     Local  145      I(4)            4           scalar                    186,187,190,191,193,196,205       
 TRIM                       Func   169                                  scalar                    169,171,173,179,200,205           
 USE_HYPER_THREAD           Dummy  131      L(4)            4           scalar   ARG,IN           159,185,189                       

Page 7           Source Listing                  FMS_AFFINITY_SET
2021-06-01 08:54                                 fms_affinity.F90

    210 end module fms_affinity_mod


SYMBOL CROSS REFERENCE

 Name                       Object Declared Type            Bytes Dimen Elements Attributes       References                        
                                                                                                                                    
 C_BOOL                     Local  31                                   scalar                    31                                
 C_INT                      Local  31                                   scalar                    31                                
 FMS_AFFINITY_GET@0         Local  44       I(4)            4           scalar                                                      
 FMS_AFFINITY_INIT          Subr   68                                                             68                                
 FMS_AFFINITY_MOD           Module 28                                                                                               
 FMS_AFFINITY_SET           Subr   68                                                             68                                
 FMS_MOD                    Module 36                                                             36                                
 GET_CPUSET@0               Local  48       I(4)            4           scalar                                                      
 ISO_C_BINDING              Module 31                                                             31                                
 MPP_MOD                    Module 35                                                             35                                
 OMP_LIB                    Module 32                                                             32                                
 SET_CPU_AFFINITY@0         Local  55       I(4)            4           scalar                                                      

Page 8           Source Listing                  FMS_AFFINITY_SET
2021-06-01 08:54 Subprograms/Common Blocks       fms_affinity.F90



SUBPROGRAMS/COMMON BLOCKS

 Name                       Object Declared Type            Bytes Dimen Elements Attributes       References                        
                                                                                                                                    
 FMS_AFFINITY_GET           Func   44       I(4)            4           scalar                                                      
 FMS_AFFINITY_INIT          Subr   104                                                                                              
 FMS_AFFINITY_MOD           Module 28                                                                                               
 FMS_AFFINITY_SET           Subr   131                                                                                              
 GET_CPUSET                 Func   48       I(4)            4           scalar                    167                               
 SET_CPU_AFFINITY           Func   55       I(4)            4           scalar                    177,198                           

COMPILER OPTIONS BEING USED

       -align noall                          -align nonone
       -align nocommons                      -align nodcommons
       -align noqcommons                     -align nozcommons
       -align records                        -align nosequence
       -align norec1byte                     -align norec2byte
       -align norec4byte                     -align norec8byte
       -align norec16byte                    -align norec32byte
       -align norec64byte                    -align noarray8byte
       -align noarray16byte                  -align noarray32byte
       -align noarray64byte                  -align noarray128byte
       -align noarray256byte                 -altparam
       -assume accuracy_sensitive            -assume nobscc
       -assume nobuffered_io                 -assume nobuffered_stdout
       -assume byterecl                      -assume nocontiguous_assumed_shape
       -assume nocontiguous_pointer          -assume cc_omp
       -assume nocstring                     -assume nodummy_aliases
       -assume nofpe_summary                 -assume noieee_fpe_flags
       -assume nominus0                      -assume noold_boz
       -assume old_complex_align             -assume old_unit_star
       -assume old_inquire_recl              -assume old_ldout_format
       -assume old_ldout_zero                -assume noold_logical_assign
       -assume noold_logical_ldio            -assume old_maxminloc
       -assume old_xor                       -assume noprotect_allocates
       -assume protect_constants             -assume noprotect_parens
       -assume split_common                  -assume source_include
       -assume nostd_intent_in               -assume std_minus0_rounding
       -assume nostd_mod_proc_name           -assume std_value
       -assume realloc_lhs                   -assume underscore
       -assume no2underscores                -assume norecursion
       -auto                            no   -auto_scalar
  no   -bintext                              -ccdefault default
       -check noarg_temp_created             -check noassume
       -check nobounds                       -check nocontiguous
       -check noformat                       -check nooutput_conversion
       -check nooverflow                     -check nopointers
       -check noshape                        -check nostack
       -check nouninitialized                -check noudio_iostat
       -coarray-num-procs 0             no   -coarray-config-file
       -convert native                       -cross_reference
       -D __INTEL_COMPILER=1910              -D __INTEL_COMPILER_UPDATE=0
       -D __unix__                           -D __unix
       -D __linux__                          -D __linux

Page 9           Source Listing                  FMS_AFFINITY_SET
2021-06-01 08:54                                 fms_affinity.F90

       -D __gnu_linux__                      -D unix
       -D linux                              -D __ELF__
       -D __x86_64                           -D __x86_64__
       -D __amd64                            -D __amd64__
       -D __INTEL_COMPILER_BUILD_DATE=20191121       -D _OPENMP=201611
       -D __INTEL_OFFLOAD                    -D __MMX__
       -D __SSE__                            -D __SSE_MATH__
       -D __SSE2__                           -D __SSE2_MATH__
       -D __pentium4                         -D __pentium4__
       -D __tune_pentium4__                  -D PACKAGE_NAME='"GFDL FMS Library"'
       -D PACKAGE_TARNAME='"FMS"'            -D PACKAGE_VERSION='"2021.02.0"'
       -D PACKAGE_STRING='"GFDL FMS Library 2021.02.0"'       -D PACKAGE_BUGREPORT='"gfdl.climate.model.info@noaa.gov"'
       -D PACKAGE_URL='"https://www.gfdl.noaa.gov/fms"'       -D PACKAGE='"FMS"'
       -D VERSION='"2021.02.0"'              -D STDC_HEADERS=1
       -D HAVE_SYS_TYPES_H=1                 -D HAVE_SYS_STAT_H=1
       -D HAVE_STDLIB_H=1                    -D HAVE_STRING_H=1
       -D HAVE_MEMORY_H=1                    -D HAVE_STRINGS_H=1
       -D HAVE_INTTYPES_H=1                  -D HAVE_STDINT_H=1
       -D HAVE_UNISTD_H=1                    -D HAVE_DLFCN_H=1
       -D LT_OBJDIR='".libs/"'               -D HAVE_MPI_H=1
       -D HAVE_NETCDF_H=1                    -D HAVE_SCHED_GETAFFINITY=1
       -D HAVE_MOD_MPI=1                     -D HAVE_MOD_NETCDF=1
       -D HAVE_CRAY_POINTER=1                -D HAVE_QUAD_PRECISION=1
       -D HAVE_INTERNAL_NML=1                -D use_netCDF=1
       -D use_libMPI=1                       -D INTERNAL_FILE_NML
       -double_size 64                  no   -d_lines
  no   -Qdyncom                              -error_limit 30
  no   -f66                             no   -f77rtl
  no   -fast                                 -fpscomp nofilesfromcmd
       -fpscomp nogeneral                    -fpscomp noioformat
       -fpscomp noldio_spacing               -fpscomp nologicals
  no   -fpconstant                           -fpe3
       -fprm nearest                         -ftz
       -fp_model noprecise                   -fp_model fast
       -fp_model nostrict                    -fp_model nosource
       -fp_model nodouble                    -fp_model noextended
       -fp_model novery_fast                 -fp_model noexcept
       -fp_model nono_except                 -fp_modbits nofp_contract
       -fp_modbits nono_fp_contract          -fp_modbits nofenv_access
       -fp_modbits nono_fenv_access          -fp_modbits nocx_limited_range
       -fp_modbits nono_cx_limited_range       -fp_modbits noprec_div
       -fp_modbits nono_prec_div             -fp_modbits noprec_sqrt
       -fp_modbits nono_prec_sqrt            -fp_modbits ftz
       -fp_modbits nono_ftz                  -fp_modbits nointrin_limited_range
       -fp_modbits nono_intrin_limited_range       -fp_modbits notrunc_compares
       -fp_modbits nono_trunc_compares       -fp_modbits noieee_nan_compares
       -fp_modbits nono_ieee_nan_compares       -fp_modbits honor_f32_conversion
       -fp_modbits nono_honor_f32_conversion       -fp_modbits honor_f64_conversion
       -fp_modbits nono_honor_f64_conversion       -fp_modbits nono_x87_copy
       -fp_modbits nono_no_x87_copy          -fp_modbits noexception_semantics
       -fp_modbits nono_exception_semantics       -fp_modbits noprecise_libm_functions
       -fp_modbits nono_precise_libm_functions       -heap_arrays 0
  no   -threadprivate_compat                 -free
       -g2                                   -iface nomixed_str_len_arg
       -iface nono_mixed_str_len_arg         -init noarrays
       -init nohuge                          -init noinfinity
       -init nominus_huge                    -init nominus_infinity

Page 10          Source Listing                  FMS_AFFINITY_SET
2021-06-01 08:54                                 fms_affinity.F90

       -init nominus_tiny                    -init nonan
       -init nosnan                          -init notiny
       -init nozero                     no   -intconstant
       -integer_size 32                 no   -mixed_str_len_arg
       -module ../.mods                      -names lowercase
  no   -noinclude                       no   -o
       -offload-build=host                   -openmp
       -openmp-simd                          -openmp-offload
       -O0                              no   -pad_source
       -real_size 64                    no   -recursive
       -reentrancy threaded                  -vec=simd
       -show nofullpath                      -show noinclude
       -show map                             -show options
  no   -syntax_only                     no   -threadcom
  no   -U                               no   -vms
       -w noall                              -w nonone
       -w noalignments                       -w nodeclarations
       -w noexternals                        -w nogeneral
       -w noignore_bounds                    -w noignore_loc
       -w nointerfaces                       -w noshape
       -w notruncated_source                 -w nouncalled
       -w nouninitialized                    -w nounused
       -w nousage                       no   -wrap-margins

       -includepath : /opt/netcdf/4.6.1/INTEL/include/,/opt/intel/2020/compilers_and_libraries/linux/pstl/include/,
           /opt/intel/2020/compilers_and_libraries_2020.0.166/linux/compiler/include/,.f90,./.f90,./.f90,../include/.f90,
           ./.f90,/opt/netcdf/4.6.1/INTEL/include/.f90,/opt/intel/2020/compilers_and_libraries/linux/mpi/intel64/include/.f90,
           /opt/intel/2020/compilers_and_libraries/linux/mpi/intel64/include/.f90,/opt/intel/2020/compilers_and_libraries/linux/ipp/include/.f90,
           /opt/intel/2020/compilers_and_libraries/linux/mkl/include/.f90,/opt/intel/2020/compilers_and_libraries/linux/pstl/include/.f90,
           /opt/intel/2020/compilers_and_libraries/linux/tbb/include/.f90,/opt/intel/2020/compilers_and_libraries/linux/daal/include/.f90,
           /opt/intel/2020/compilers_and_libraries_2020.0.166/linux/compiler/include/intel64/.f90,/opt/intel/2020/compilers_and_libraries_2020.0.166/linux/compiler/include/icc/.f90,
           /opt/intel/2020/compilers_and_libraries_2020.0.166/linux/compiler/include/.f90,/usr/local/include/.f90,
           /usr/lib/gcc/x86_64-redhat-linux/4.8.5/include/.f90,/usr/include/.f90,/usr/include/.f90,/usr/include/.f90
       -list filename : fms_affinity.lst
  no   -o

COMPILER: Intel(R) Fortran 19.1-1555
