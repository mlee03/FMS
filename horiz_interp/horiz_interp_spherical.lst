Page 1           Source Listing                  HORIZ_INTERP_SPHERICAL_INIT
2021-06-01 08:55                                 /tmp/ifortiieDpt.i90

      1 # 1 "horiz_interp_spherical.F90"
      2 !***********************************************************************
      3 !*                   GNU Lesser General Public License
      4 !*
      5 !* This file is part of the GFDL Flexible Modeling System (FMS).
      6 !*
      7 !* FMS is free software: you can redistribute it and/or modify it under
      8 !* the terms of the GNU Lesser General Public License as published by
      9 !* the Free Software Foundation, either version 3 of the License, or (at
     10 !* your option) any later version.
     11 !*
     12 !* FMS is distributed in the hope that it will be useful, but WITHOUT
     13 !* ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
     14 !* FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
     15 !* for more details.
     16 !*
     17 !* You should have received a copy of the GNU Lesser General Public
     18 !* License along with FMS.  If not, see <http://www.gnu.org/licenses/>.
     19 !***********************************************************************
     20 module horiz_interp_spherical_mod
     21 
     22 ! <CONTACT EMAIL="Matthew.Harrison@noaa.gov"> Matthew Harrison </CONTACT>
     23 ! <CONTACT EMAIL="Zhi.Liang@noaa.gov"> Zhi Liang </CONTACT>
     24 
     25 ! <HISTORY SRC="http://www.gfdl.noaa.gov/fms-cgi-bin/cvsweb.cgi/FMS/"/>
     26 
     27 ! <OVERVIEW>
     28 !   Performs spatial interpolation between grids using inverse-distance-weighted scheme.
     29 ! </OVERVIEW>
     30 
     31 ! <DESCRIPTION>
     32 !     This module can interpolate data from rectangular/tripolar grid
     33 !     to rectangular/tripolar grid. The interpolation scheme is inverse-distance-weighted
     34 !     scheme.    There is an optional mask field for missing input data.
     35 !     An optional output mask field may be used in conjunction with
     36 !     the input mask to show where output data exists.
     37 ! </DESCRIPTION>
     38 
     39   use mpp_mod,               only : mpp_error, FATAL, WARNING, stdout
     40   use mpp_mod,               only : mpp_root_pe, mpp_pe
     41   use mpp_mod,               only : input_nml_file
     42   use fms_mod,               only : write_version_number
     43   use fms_mod,               only : check_nml_error
     44   use constants_mod,         only : pi
     45   use horiz_interp_type_mod, only : horiz_interp_type, stats
     46 
     47   implicit none
     48   private
     49 
     50 
     51   public :: horiz_interp_spherical_new, horiz_interp_spherical, horiz_interp_spherical_del
     52   public :: horiz_interp_spherical_init, horiz_interp_spherical_wght
     53 
     54   integer, parameter :: max_neighbors = 400
     55   real,    parameter :: max_dist_default = 0.1  ! radians
     56   integer, parameter :: num_nbrs_default = 4
     57   real,    parameter :: large=1.e20

Page 2           Source Listing                  HORIZ_INTERP_SPHERICAL_INIT
2021-06-01 08:55                                 horiz_interp_spherical.F90

     58   real,    parameter :: epsln=1.e-10
     59 
     60   integer            :: pe, root_pe
     61 
     62 
     63 !--- namelist interface
     64 !<NAMELIST NAME="horiz_interp_spherical_nml">
     65 ! <DATA NAME="search_method" TYPE="character(len=32)">
     66 !  indicate the searching method to find the nearest neighbor points. Its value
     67 !  can be "radial_search" and "full_search", with default value "radial_search".
     68 !  when search_method is "radial_search", the search may be not quite accurate for some cases.
     69 !  Normally the search will be ok if you chose suitable max_dist.
     70 !  When search_method is "full_search", it will be always accurate, but will be slower
     71 !  comparing to "radial_search". Normally these two search algorithm will produce same
     72 !  results other than order of operation. "radial_search" are recommended to use.
     73 !  The purpose to add "full_search" is in case you think you interpolation results is
     74 !  not right, you have other option to verify.
     75 ! </DATA>
     76 !</NAMELIST>
     77 
     78   character(len=32) :: search_method = "radial_search" ! or "full_search"
     79   namelist /horiz_interp_spherical_nml/ search_method
     80 
     81 !-----------------------------------------------------------------------
     82 ! Include variable "version" to be written to log file.
     83 # 1 "../include/file_version.h" 1 
     84 ! -*-f90-*-
     85 !***********************************************************************
     86 !*                   GNU Lesser General Public License
     87 !*
     88 !* This file is part of the GFDL Flexible Modeling System (FMS).
     89 !*
     90 !* FMS is free software: you can redistribute it and/or modify it under
     91 !* the terms of the GNU Lesser General Public License as published by
     92 !* the Free Software Foundation, either version 3 of the License, or (at
     93 !* your option) any later version.
     94 !*
     95 !* FMS is distributed in the hope that it will be useful, but WITHOUT
     96 !* ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
     97 !* FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
     98 !* for more details.
     99 !*
    100 !* You should have received a copy of the GNU Lesser General Public
    101 !* License along with FMS.  If not, see <http://www.gnu.org/licenses/>.
    102 !***********************************************************************
    103 
    104 # 23
    105 
    106   character(len=*), parameter :: version = 'unknown'
    107 
    108 # 83 "horiz_interp_spherical.F90" 2 
    109   logical            :: module_is_initialized = .FALSE.
    110 
    111 contains
    112 
    113 !#######################################################################
    114 !  <SUBROUTINE NAME="horiz_interp_spherical_init">

Page 3           Source Listing                  HORIZ_INTERP_SPHERICAL_INIT
2021-06-01 08:55                                 horiz_interp_spherical.F90

    115 !  <OVERVIEW>
    116 !     writes version number to logfile.out
    117 !  </OVERVIEW>
    118 !  <DESCRIPTION>
    119 !     writes version number to logfile.out
    120 !  </DESCRIPTION>
    121 
    122   subroutine horiz_interp_spherical_init
    123     integer :: unit, ierr, io
    124 
    125 
    126     if(module_is_initialized) return
    127     call write_version_number("horiz_interp_spherical_mod", version)
    128     read (input_nml_file, horiz_interp_spherical_nml, iostat=io)
    129     ierr = check_nml_error(io,'horiz_interp_spherical_nml')
    130 
    131  module_is_initialized = .true.
    132 
    133 
    134 
    135 end subroutine horiz_interp_spherical_init


ENTRY POINTS

  Name                                                                  
                                                                        
 horiz_interp_spherical_mod_mp_horiz_interp_spherical_init_             

Page 4           Source Listing                  HORIZ_INTERP_SPHERICAL_INIT
2021-06-01 08:55 Symbol Table                    horiz_interp_spherical.F90



SYMBOL CROSS REFERENCE

 Name                       Object Declared Type            Bytes Dimen Elements Attributes       References                        
                                                                                                                                    
 CHECK_NML_ERROR            Func   129      I(4)            4           scalar   PRIV             43,129                            
 HORIZ_INTERP_SPHERICAL_INI                                                                                                         
 T                          Subr   122                                                                                              
 HORIZ_INTERP_SPHERICAL_NML Local  128                                  scalar                    128                               
 IERR                       Local  123      I(4)            4           scalar                    129                               
 INPUT_NML_FILE             Local  128      CHAR                  1     1        ALC,TGT,PRIV     41,128                            
 IO                         Local  123      I(4)            4           scalar                    128,129                           
 MODULE_IS_INITIALIZED      Local  126      L(4)            4           scalar                    109,126,131                       
 UNIT                       Local  123      I(4)            4           scalar                                                      
 VERSION                    Param  127      CHAR            7           scalar                    127                               
 WRITE_VERSION_NUMBER       Subr   127                                           PRIV             42,127                            

Page 5           Source Listing                  HORIZ_INTERP_SPHERICAL_INIT
2021-06-01 08:55                                 horiz_interp_spherical.F90

    136 
    137 !  </SUBROUTINE>
    138 
    139 !#######################################################################
    140 ! <SUBROUTINE NAME="horiz_interp_spherical_new">
    141 
    142 !   <OVERVIEW>
    143 !      Initialization routine.
    144 !   </OVERVIEW>
    145 !   <DESCRIPTION>
    146 !      Allocates space and initializes a derived-type variable
    147 !      that contains pre-computed interpolation indices and weights.
    148 !   </DESCRIPTION>
    149 !   <TEMPLATE>
    150 !     call horiz_interp_spherical_new(Interp, lon_in,lat_in,lon_out,lat_out, num_nbrs, max_dist, src_modulo)
    151 !   </TEMPLATE>
    152 !
    153 !   <IN NAME="lon_in" TYPE="real, dimension(:,:)" UNITS="radians">
    154 !      Longitude (in radians) for source data grid.
    155 !   </IN>
    156 
    157 !   <IN NAME="lat_in" TYPE="real, dimension(:,:)" UNITS="radians">
    158 !      Latitude (in radians) for source data grid.
    159 !   </IN>
    160 
    161 !   <IN NAME="lon_out" TYPE="real, dimension(:,:)" UNITS="radians" >
    162 !      Longitude (in radians) for source data grid.
    163 !   </IN>
    164 
    165 !   <IN NAME="lat_out" TYPE="real, dimension(:,:)" UNITS="radians" >
    166 !      Latitude (in radians) for source data grid.
    167 !   </IN>
    168 
    169 !   <IN NAME="num_nbrs" TYPE="integer, optional">
    170 !     Number of nearest neighbors for regridding. When number of neighbors within
    171 !     the radius max_dist ( namelist variable) is less than num_nbrs, All the neighbors
    172 !     will be used to interpolate onto destination grid. when number of neighbors within
    173 !     the radius max_dist ( namelist variable) is greater than num_nbrs, at least "num_nbrs"
    174 !     neighbors will be used to remap onto destination grid.
    175 !   </IN>
    176 
    177 !   <IN NAME="max_dist" TYPE="real, optional" UNITS="radians">
    178 !      Maximum region of influence around destination grid points.
    179 !   </IN>
    180 
    181 !   <IN NAME="src_modulo" TYPE="logical, optional">
    182 !      logical variable to indicate if the boundary condition along zonal boundary
    183 !      is cyclic or not. When true, the zonal boundary condition is cyclic.
    184 !   </IN>
    185 
    186 !   <INOUT NAME="Interp" TYPE="type(horiz_interp_type)">
    187 !      A derived-type variable containing indices and weights used for subsequent
    188 !      interpolations. To reinitialize this variable for a different grid-to-grid
    189 !      interpolation you must first use the "horiz_interp_del" interface.
    190 !   </INOUT>
    191 
    192   subroutine horiz_interp_spherical_new(Interp, lon_in,lat_in,lon_out,lat_out, &

Page 6           Source Listing                  HORIZ_INTERP_SPHERICAL_NEW
2021-06-01 08:55                                 horiz_interp_spherical.F90

    193        num_nbrs, max_dist, src_modulo)
    194     type(horiz_interp_type), intent(inout) :: Interp
    195     real, intent(in),       dimension(:,:) :: lon_in, lat_in, lon_out, lat_out
    196     integer, intent(in),        optional   :: num_nbrs
    197     real, optional,             intent(in) :: max_dist
    198     logical,          intent(in), optional :: src_modulo
    199 
    200 !------local variables ---------------------------------------
    201     integer :: i, j, n
    202     integer :: map_dst_xsize, map_dst_ysize, map_src_xsize, map_src_ysize
    203     integer :: map_src_size, num_neighbors
    204     real    :: max_src_dist, tpi, hpi
    205     logical :: src_is_modulo
    206     real    :: min_theta_dst, max_theta_dst, min_phi_dst, max_phi_dst
    207     real    :: min_theta_src, max_theta_src, min_phi_src, max_phi_src
    208     integer :: map_src_add(size(lon_out,1),size(lon_out,2),max_neighbors)
    209     real    :: map_src_dist(size(lon_out,1),size(lon_out,2),max_neighbors)
    210     integer :: num_found(size(lon_out,1),size(lon_out,2))
    211     integer :: ilon(max_neighbors), jlat(max_neighbors)
    212     real, dimension(size(lon_out,1),size(lon_out,2)) :: theta_dst, phi_dst
    213     real, dimension(size(lon_in,1)*size(lon_in,2))   :: theta_src, phi_src
    214 
    215 !--------------------------------------------------------------
    216 
    217     pe      = mpp_pe()
    218     root_pe = mpp_root_pe()
    219 
    220     tpi = 2.0*PI; hpi = 0.5*PI
    221 
    222     num_neighbors = num_nbrs_default
    223     if(present(num_nbrs)) num_neighbors = num_nbrs
    224     if (num_neighbors <= 0) call mpp_error(FATAL,'horiz_interp_spherical_mod: num_neighbors must be > 0')
    225 
    226     max_src_dist = max_dist_default
    227     if (PRESENT(max_dist)) max_src_dist = max_dist
    228     Interp%max_src_dist = max_src_dist
    229 
    230     src_is_modulo = .true.
    231     if (PRESENT(src_modulo)) src_is_modulo = src_modulo
    232 
    233 !--- check the grid size comformable
    234     map_dst_xsize=size(lon_out,1);map_dst_ysize=size(lon_out,2)
    235     map_src_xsize=size(lon_in,1); map_src_ysize=size(lon_in,2)
    236     map_src_size = map_src_xsize*map_src_ysize
    237 
    238     if (map_dst_xsize /= size(lat_out,1) .or. map_dst_ysize /= size(lat_out,2)) &
    239          call mpp_error(FATAL,'horiz_interp_spherical_mod: destination grids not conformable')
    240     if (map_src_xsize /= size(lat_in,1) .or. map_src_ysize /= size(lat_in,2)) &
    241          call mpp_error(FATAL,'horiz_interp_spherical_mod: source grids not conformable')
    242 
    243     theta_src      = reshape(lon_in,(/map_src_size/))
    244     phi_src        = reshape(lat_in,(/map_src_size/))
    245     theta_dst(:,:) = lon_out(:,:)
    246     phi_dst(:,:)   = lat_out(:,:)
    247 
    248     min_theta_dst=tpi;max_theta_dst=0.0;min_phi_dst=pi;max_phi_dst=-pi
    249     min_theta_src=tpi;max_theta_src=0.0;min_phi_src=pi;max_phi_src=-pi

Page 7           Source Listing                  HORIZ_INTERP_SPHERICAL_NEW
2021-06-01 08:55                                 horiz_interp_spherical.F90

    250 
    251     where(theta_dst<0.0)  theta_dst = theta_dst+tpi
    252     where(theta_dst>tpi)  theta_dst = theta_dst-tpi
    253     where(theta_src<0.0)  theta_src = theta_src+tpi
    254     where(theta_src>tpi)  theta_src = theta_src-tpi
    255 
    256     where(phi_dst < -hpi) phi_dst = -hpi
    257     where(phi_dst > hpi)  phi_dst =  hpi
    258     where(phi_src < -hpi) phi_src = -hpi
    259     where(phi_src > hpi)  phi_src =  hpi
    260 
    261     do j=1,map_dst_ysize
    262        do i=1,map_dst_xsize
    263           min_theta_dst = min(min_theta_dst,theta_dst(i,j))
    264           max_theta_dst = max(max_theta_dst,theta_dst(i,j))
    265           min_phi_dst = min(min_phi_dst,phi_dst(i,j))
    266           max_phi_dst = max(max_phi_dst,phi_dst(i,j))
    267        enddo
    268     enddo
    269 
    270     do i=1,map_src_size
    271        min_theta_src = min(min_theta_src,theta_src(i))
    272        max_theta_src = max(max_theta_src,theta_src(i))
    273        min_phi_src = min(min_phi_src,phi_src(i))
    274        max_phi_src = max(max_phi_src,phi_src(i))
    275     enddo
    276 
    277     if (min_phi_dst < min_phi_src) print *, '=> WARNING:  latitute of dest grid exceeds src'
    278     if (max_phi_dst > max_phi_src) print *, '=> WARNING:  latitute of dest grid exceeds src'
    279 ! when src is cyclic, no need to print out the following warning.
    280     if(.not. src_is_modulo) then
    281        if (min_theta_dst < min_theta_src) print *, '=> WARNING : longitude of dest grid exceeds src'
    282        if (max_theta_dst > max_theta_src) print *, '=> WARNING : longitude of dest grid exceeds src'
    283     endif
    284 
    285 ! allocate memory to data type
    286     if(ASSOCIATED(Interp%i_lon)) then
    287        if(size(Interp%i_lon,1) .NE. map_dst_xsize .OR.     &
    288           size(Interp%i_lon,2) .NE. map_dst_ysize )  call mpp_error(FATAL, &
    289           'horiz_interp_spherical_mod: size(Interp%i_lon(:),1) .NE. map_dst_xsize .OR. '// &
    290           'size(Interp%i_lon(:),2) .NE. map_dst_ysize')
    291     else
    292        allocate(Interp%i_lon(map_dst_xsize,map_dst_ysize,max_neighbors), &
    293             Interp%j_lat(map_dst_xsize,map_dst_ysize,max_neighbors),     &
    294             Interp%src_dist(map_dst_xsize,map_dst_ysize,max_neighbors),  &
    295             Interp%num_found(map_dst_xsize,map_dst_ysize)       )
    296     endif
    297 
    298     map_src_add         = 0
    299     map_src_dist        = large
    300     num_found           = 0
    301 
    302 !using radial_search to find the nearest points and corresponding distance.
    303 
    304     select case(trim(search_method))
    305     case ("radial_search") ! will be efficient, but may be not so accurate for some cases
    306        call radial_search(theta_src, phi_src, theta_dst, phi_dst, map_src_xsize, map_src_ysize, &

Page 8           Source Listing                  HORIZ_INTERP_SPHERICAL_NEW
2021-06-01 08:55                                 horiz_interp_spherical.F90

    307             map_src_add, map_src_dist, num_found, num_neighbors,max_src_dist,src_is_modulo)
    308     case ("full_search")   ! always accurate, but less efficient.
    309        call full_search(theta_src, phi_src, theta_dst, phi_dst, map_src_add, map_src_dist, &
    310             num_found, num_neighbors,max_src_dist )
    311     case default
    312        call mpp_error(FATAL,"horiz_interp_spherical_new: nml search_method = "// &
    313                   trim(search_method)//" is not a valid namelist option")
    314     end select
    315 
    316     do j=1,map_dst_ysize
    317        do i=1,map_dst_xsize
    318           do n=1,num_found(i,j)
    319              if(map_src_add(i,j,n) == 0) then
    320                 jlat(n) = 0; ilon(n) = 0
    321              else
    322                 jlat(n) = map_src_add(i,j,n)/map_src_xsize + 1
    323                 ilon(n) = map_src_add(i,j,n) - (jlat(n)-1)*map_src_xsize
    324                 if(ilon(n) == 0) then
    325                    jlat(n) = jlat(n) - 1
    326                    ilon(n) = map_src_xsize
    327                 endif
    328              endif
    329           enddo
    330           Interp%i_lon(i,j,:)         = ilon(:)
    331           Interp%j_lat(i,j,:)         = jlat(:)
    332           Interp%num_found(i,j)       = num_found(i,j)
    333           Interp%src_dist(i,j,:)      = map_src_dist(i,j,:)
    334        enddo
    335     enddo
    336 
    337     Interp%nlon_src = map_src_xsize; Interp%nlat_src = map_src_ysize
    338     Interp%nlon_dst = map_dst_xsize; Interp%nlat_dst = map_dst_ysize
    339 
    340     return
    341 
    342   end subroutine horiz_interp_spherical_new

Page 9           Source Listing                  HORIZ_INTERP_SPHERICAL_NEW
2021-06-01 08:55 Entry Points                    horiz_interp_spherical.F90



ENTRY POINTS

  Name                                                                 
                                                                       
 horiz_interp_spherical_mod_mp_horiz_interp_spherical_new_             


SYMBOL CROSS REFERENCE

 Name                       Object Declared Type            Bytes Dimen Elements Attributes       References                        
                                                                                                                                    
 ASSOCIATED                 Func   286                                  scalar                    286                               
 FATAL                      Param  224      I(4)            4           scalar   PRIV             39,224,239,241,288,312,409,412,890
 HORIZ_INTERP_SPHERICAL_NEW Subr   192                                                                                              
 HORIZ_INTERP_TYPE          Type   194                                  scalar   PRIV             45,194,386,522,629                
 HPI                        Local  204      R(8)            8           scalar                    220,256,257,258,259               
 I                          Local  201      I(4)            4           scalar                    262,263,264,265,266,270,271,272,27
                                                                                                  3,274,317,318,319,322,323,330,331,
                                                                                                  332,333                           
 ILON                       Local  211      I(4)            4     1     400                       320,323,324,326,330               
 INTERP                     Dummy  192      HORIZ_INTERP_TYPE                                                                       
                                                            2208        scalar   ARG,INOUT        228,286,287,288,292,293,294,295,33
                                                                                                  0,331,332,333,337,338             
 J                          Local  201      I(4)            4           scalar                    261,263,264,265,266,316,318,319,32
                                                                                                  2,323,330,331,332,333             
 JLAT                       Local  211      I(4)            4     1     400                       320,322,323,325,331               
 LARGE                      Param  299      R(8)            8           scalar                    299,445,446,579,580               
 LAT_IN                     Dummy  192      R(8)            8     2     1        ARG,IN           240,244                           
 LAT_OUT                    Dummy  192      R(8)            8     2     1        ARG,IN           238,246                           
 LON_IN                     Dummy  192      R(8)            8     2     1        ARG,IN           235,243                           
 LON_OUT                    Dummy  192      R(8)            8     2     1        ARG,IN           208,209,210,234,245               
 MAP_DST_XSIZE              Local  202      I(4)            4           scalar                    234,238,262,287,292,293,294,295,31
                                                                                                  7,338                             
 MAP_DST_YSIZE              Local  202      I(4)            4           scalar                    234,238,261,288,292,293,294,295,31
                                                                                                  6,338                             
 MAP_SRC_ADD                Local  208      I(4)            4     3     0        TGT              298,307,309,319,322,323           
 MAP_SRC_DIST               Local  209      R(8)            8     3     0        TGT              299,307,309,333                   
 MAP_SRC_SIZE               Local  203      I(4)            4           scalar                    236,243,244,270                   
 MAP_SRC_XSIZE              Local  202      I(4)            4           scalar                    235,236,240,306,322,323,326,337   
 MAP_SRC_YSIZE              Local  202      I(4)            4           scalar                    235,236,240,306,337               
 MAX                        Func   264                                  scalar                    264,266,272,274                   
 MAX_DIST                   Dummy  193      R(8)            8           scalar   ARG,IN           227                               
 MAX_DIST_DEFAULT           Param  226      R(8)            8           scalar                    226                               
 MAX_NEIGHBORS              Param  208      I(4)            4           scalar                    208,209,211,292,293,294,887       
 MAX_PHI_DST                Local  206      R(8)            8           scalar                    248,266,278                       
 MAX_PHI_SRC                Local  207      R(8)            8           scalar                    249,274,278                       
 MAX_SRC_DIST               Local  204      R(8)            8           scalar                    226,227,228,307,310               
 MAX_THETA_DST              Local  206      R(8)            8           scalar                    248,264,282                       
 MAX_THETA_SRC              Local  207      R(8)            8           scalar                    249,272,282                       
 MIN                        Func   263                                  scalar                    263,265,271,273                   
 MIN_PHI_DST                Local  206      R(8)            8           scalar                    248,265,277                       
 MIN_PHI_SRC                Local  207      R(8)            8           scalar                    249,273,277                       
 MIN_THETA_DST              Local  206      R(8)            8           scalar                    248,263,281                       
 MIN_THETA_SRC              Local  207      R(8)            8           scalar                    249,271,281                       
 MPP_ERROR                  Local  224                                  scalar   PRIV             39,224,239,241,288,312,409,412,890

Page 10          Source Listing                  HORIZ_INTERP_SPHERICAL_NEW
2021-06-01 08:55 Symbol Table                    horiz_interp_spherical.F90

 Name                       Object Declared Type            Bytes Dimen Elements Attributes       References                        
                                                                                                                                    
 MPP_ERROR_BASIC            Subr   224                                           PRIV             224,239,241,288,312,409,412,890   
 MPP_PE                     Func   217      I(4)            4           scalar   PRIV             40,217,552                        
 MPP_ROOT_PE                Func   218      I(4)            4           scalar   PRIV             40,218                            
 N                          Local  201      I(4)            4           scalar                    318,319,320,322,323,324,325,326   
 NUM_FOUND                  Local  210      I(4)            4     2     0        TGT              300,307,310,318,332               
 NUM_NBRS                   Dummy  193      I(4)            4           scalar   ARG,IN           223                               
 NUM_NBRS_DEFAULT           Param  222      I(4)            4           scalar                    222,551,553                       
 NUM_NEIGHBORS              Local  203      I(4)            4           scalar                    222,223,224,307,310               
 PE                         Local  217      I(4)            4           scalar                    217,502                           
 PHI_DST                    Local  212      R(8)            8     2     0        TGT              246,256,257,265,266,306,309       
 PHI_SRC                    Local  213      R(8)            8     1     0        TGT              244,258,259,273,274,306,309       
 PI                         Param  220      R(8)            8           scalar   PRIV             44,220,248,249                    
 PRESENT                    Func   223                                  scalar                    223,227,231                       
 RESHAPE                    Func   243                                  scalar                    243,244                           
 ROOT_PE                    Local  218      I(4)            4           scalar                    218,502                           
 SEARCH_METHOD              Local  304      CHAR            32          scalar                    78,79,304,313                     
 SIZE                       Func   208                                  scalar                    208,209,210,234,235,238,240,287,28
                                                                                                  8                                 
 SRC_IS_MODULO              Local  205      L(4)            4           scalar                    230,231,280,307                   
 SRC_MODULO                 Dummy  193      L(4)            4           scalar   ARG,IN           231                               
 THETA_DST                  Local  212      R(8)            8     2     0        TGT              245,251,252,263,264,306,309       
 THETA_SRC                  Local  213      R(8)            8     1     0        TGT              243,253,254,271,272,306,309       
 TPI                        Local  204      R(8)            8           scalar                    220,248,249,251,252,253,254       
 TRIM                       Func   304                                  scalar                    304,313                           


TYPE COMPONENTS/COMMON VARIABLES

 Name                       Type            Bytes Offset   Dimen Elements Attributes       References                         
                                                                                                                              
 HORIZ_INTERP_TYPE.I_LON    I(4)            4     816      3     1        PTR              286,287,288,292,330,425,431,441,47 
                                                                                           1,559,565,575,633                  
 HORIZ_INTERP_TYPE.J_LAT    I(4)            4     936      3     1        PTR              293,331,425,431,441,472,559,565,57 
                                                                                           5,634                              
 HORIZ_INTERP_TYPE.MAX_SRC_DIST                                                                                            ...
                            R(8)            8     1272           scalar                    228,447,581                        
 HORIZ_INTERP_TYPE.NLAT_DST I(4)            4     1388           scalar                    338,395,397,406,531,540            
 HORIZ_INTERP_TYPE.NLAT_SRC I(4)            4     1380           scalar                    337,396,405,530,539                
 HORIZ_INTERP_TYPE.NLON_DST I(4)            4     1384           scalar                    338,395,397,406,531,540            
 HORIZ_INTERP_TYPE.NLON_SRC I(4)            4     1376           scalar                    337,396,405,530,539                
 HORIZ_INTERP_TYPE.NUM_FOUND                                                                                               ...
                            I(4)            4     1280     2     1        PTR              295,332,421,470,549,632            
 HORIZ_INTERP_TYPE.SRC_DIST R(8)            8     1056     3     1        PTR              294,333,395,434,444,447,448,568,57 
                                                                                           8,581,582,631                      

Page 11          Source Listing                  HORIZ_INTERP_SPHERICAL_NEW
2021-06-01 08:55                                 horiz_interp_spherical.F90

    343 ! </SUBROUTINE>
    344 
    345 !#######################################################################
    346 ! <SUBROUTINE NAME="horiz_interp_spherical">
    347 
    348 !   <OVERVIEW>
    349 !      Subroutine for performing the horizontal interpolation between two grids.
    350 !   </OVERVIEW>
    351 !   <DESCRIPTION>
    352 !     Subroutine for performing the horizontal interpolation between two grids.
    353 !     horiz_interp_spherical_new must be called before calling this routine.
    354 !   </DESCRIPTION>
    355 !   <TEMPLATE>
    356 !     call horiz_interp_spherical( Interp, data_in, data_out, verbose, mask_in, mask_out, missing_value)
    357 !   </TEMPLATE>
    358 !
    359 !   <IN NAME="Interp" TYPE="type(horiz_interp_type)">
    360 !     Derived-type variable containing interpolation indices and weights.
    361 !     Returned by a previous call to horiz_interp_spherical_new.
    362 !   </IN>
    363 !   <IN NAME="data_in" TYPE="real, dimension(:,:)">
    364 !      Input data on source grid.
    365 !   </IN>
    366 !   <IN NAME="verbose" TYPE="integer, optional">
    367 !      flag for the amount of print output.
    368 !               verbose = 0, no output; = 1, min,max,means; = 2, still more
    369 !   </IN>
    370 !   <IN NAME="mask_in" TYPE="real, dimension(:,:),optional">
    371 !      Input mask, must be the same size as the input data. The real value of
    372 !      mask_in must be in the range (0.,1.). Set mask_in=0.0 for data points
    373 !      that should not be used or have missing data.
    374 !   </IN>
    375 !   <IN NAME="missing_value" TYPE="real, optional">
    376 !      Use the missing_value to indicate missing data.
    377 !   </IN>
    378 !   <OUT NAME="data_out" TYPE="real, dimension(:,:)">
    379 !      Output data on destination grid.
    380 !   </OUT>
    381 !   <OUT NAME="mask_out" TYPE="real, dimension(:,:),optional">
    382 !      Output mask that specifies whether data was computed.
    383 !   </OUT>
    384 
    385   subroutine horiz_interp_spherical( Interp, data_in, data_out, verbose, mask_in, mask_out, missing_value)
    386     type (horiz_interp_type), intent(in)        :: Interp
    387     real, intent(in),  dimension(:,:)           :: data_in
    388     real, intent(out), dimension(:,:)           :: data_out
    389     integer, intent(in),               optional :: verbose
    390     real, intent(in), dimension(:,:),  optional :: mask_in
    391     real, intent(out), dimension(:,:), optional :: mask_out
    392     real, intent(in),                  optional :: missing_value
    393 
    394 !--- some local variables ----------------------------------------
    395     real, dimension(Interp%nlon_dst, Interp%nlat_dst,size(Interp%src_dist,3)) :: wt
    396     real, dimension(Interp%nlon_src, Interp%nlat_src) :: mask_src
    397     real, dimension(Interp%nlon_dst, Interp%nlat_dst) :: mask_dst
    398     integer :: nlon_in, nlat_in, nlon_out, nlat_out, num_found
    399     integer :: m, n, i, j, k, miss_in, miss_out, i1, i2, j1, j2, iverbose

Page 12          Source Listing                  HORIZ_INTERP_SPHERICAL
2021-06-01 08:55                                 horiz_interp_spherical.F90

    400     real    :: min_in, max_in, avg_in, min_out, max_out, avg_out, sum
    401 !-----------------------------------------------------------------
    402 
    403     iverbose = 0;  if (present(verbose)) iverbose = verbose
    404 
    405     nlon_in  = Interp%nlon_src; nlat_in  = Interp%nlat_src
    406     nlon_out = Interp%nlon_dst; nlat_out = Interp%nlat_dst
    407 
    408     if(size(data_in,1) .ne. nlon_in .or. size(data_in,2) .ne. nlat_in ) &
    409          call mpp_error(FATAL,'horiz_interp_spherical_mod: size of input array incorrect')
    410 
    411     if(size(data_out,1) .ne. nlon_out .or. size(data_out,2) .ne. nlat_out ) &
    412          call mpp_error(FATAL,'horiz_interp_spherical_mod: size of output array incorrect')
    413 
    414     mask_src = 1.0; mask_dst = 1.0
    415     if(present(mask_in)) mask_src = mask_in
    416 
    417     do n=1,nlat_out
    418        do m=1,nlon_out
    419 ! neighbors are sorted nearest to farthest
    420 ! check nearest to see if it is a land point
    421           num_found = Interp%num_found(m,n)
    422           if(num_found == 0 ) then
    423              mask_dst(m,n) = 0.0
    424           else
    425              i1 = Interp%i_lon(m,n,1); j1 = Interp%j_lat(m,n,1)
    426              if (mask_src(i1,j1) .lt. 0.5) then
    427                 mask_dst(m,n) = 0.0
    428              endif
    429 
    430              if(num_found .gt. 1 ) then
    431                 i2 = Interp%i_lon(m,n,2); j2 = Interp%j_lat(m,n,2)
    432 ! compare first 2 nearest neighbors -- if they are nearly
    433 ! equidistant then use this mask for robustness
    434                 if(abs(Interp%src_dist(m,n,2)-Interp%src_dist(m,n,1)) .lt. epsln) then
    435                    if((mask_src(i1,j1) .lt. 0.5))  mask_dst(m,n) = 0.0
    436                 endif
    437              endif
    438 
    439              sum=0.0
    440              do k=1, num_found
    441                 if(mask_src(Interp%i_lon(m,n,k),Interp%j_lat(m,n,k)) .lt. 0.5 ) then
    442                    wt(m,n,k) = 0.0
    443                 else
    444                    if (Interp%src_dist(m,n,k) <= epsln) then
    445                       wt(m,n,k) = large
    446                       sum = sum + large
    447                    else if(Interp%src_dist(m,n,k) <= Interp%max_src_dist ) then
    448                       wt(m,n,k) = 1.0/Interp%src_dist(m,n,k)
    449                       sum = sum+wt(m,n,k)
    450                    else
    451                       wt(m,n,k) = 0.0
    452                    endif
    453                 endif
    454              enddo
    455              if (sum > epsln) then
    456                 do k = 1, num_found

Page 13          Source Listing                  HORIZ_INTERP_SPHERICAL
2021-06-01 08:55                                 horiz_interp_spherical.F90

    457                    wt(m,n,k) = wt(m,n,k)/sum
    458                 enddo
    459              else
    460                 mask_dst(m,n) = 0.0
    461              endif
    462           endif
    463        enddo
    464     enddo
    465 
    466     data_out = 0.0
    467     do n=1,nlat_out
    468        do m=1,nlon_out
    469           if(mask_dst(m,n) .gt. 0.5) then
    470              do k=1, Interp%num_found(m,n)
    471                 i = Interp%i_lon(m,n,k)
    472                 j = Interp%j_lat(m,n,k)
    473                 data_out(m,n) = data_out(m,n)+data_in(i,j)*wt(m,n,k)
    474              enddo
    475           else
    476              if(present(missing_value)) then
    477                 data_out(m,n) = missing_value
    478              else
    479                 data_out(m,n) = 0.0
    480              endif
    481           endif
    482        enddo
    483     enddo
    484 
    485     if(present(mask_out)) mask_out = mask_dst
    486 
    487 !***********************************************************************
    488 ! compute statistics: minimum, maximum, and mean
    489 !-----------------------------------------------------------------------
    490 
    491     if (iverbose > 0) then
    492 
    493 ! compute statistics of input data
    494 
    495        call stats (data_in, min_in, max_in, avg_in, miss_in, missing_value, mask=mask_src)
    496 
    497 ! compute statistics of output data
    498        call stats (data_out, min_out, max_out, avg_out, miss_out, missing_value, mask=mask_dst)
    499 
    500 !---- output statistics ----
    501 ! root_pe have the information of global mean, min and max
    502        if(pe == root_pe) then
    503           write (*,900)
    504           write (*,901)  min_in ,max_in, avg_in
    505           if (present(mask_in))  write (*,903)  miss_in
    506           write (*,902)  min_out,max_out,avg_out
    507           if (present(mask_out)) write (*,903)  miss_out
    508        endif
    509 900    format (/,1x,10('-'),' output from horiz_interp ',10('-'))
    510 901    format ('  input:  min=',f16.9,'  max=',f16.9,'  avg=',f22.15)
    511 902    format (' output:  min=',f16.9,'  max=',f16.9,'  avg=',f22.15)
    512 903    format ('          number of missing points = ',i6)
    513 

Page 14          Source Listing                  HORIZ_INTERP_SPHERICAL
2021-06-01 08:55                                 horiz_interp_spherical.F90

    514     endif
    515 
    516     return
    517   end subroutine horiz_interp_spherical


ENTRY POINTS

  Name                                                             
                                                                   
 horiz_interp_spherical_mod_mp_horiz_interp_spherical_             


SYMBOL CROSS REFERENCE

 Name                       Object Declared Type            Bytes Dimen Elements Attributes       References                        
                                                                                                                                    
 900                        Label  509                                                            503                               
 901                        Label  510                                                            504                               
 902                        Label  511                                                            506                               
 903                        Label  512                                                            505,507                           
 ABS                        Func   434                                  scalar                    434                               
 AVG_IN                     Local  400      R(8)            8           scalar                    495,504                           
 AVG_OUT                    Local  400      R(8)            8           scalar                    498,506                           
 DATA_IN                    Dummy  385      R(8)            8     2     1        ARG,IN           408,473,495                       
 DATA_OUT                   Dummy  385      R(8)            8     2     1        ARG,OUT          411,466,473,477,479,498           
 EPSLN                      Param  434      R(8)            8           scalar                    434,444,455,568,578,589           
 HORIZ_INTERP_SPHERICAL     Subr   385                                                                                              
 I                          Local  399      I(4)            4           scalar                    471,473                           
 I1                         Local  399      I(4)            4           scalar                    425,426,435                       
 I2                         Local  399      I(4)            4           scalar                    431                               
 INTERP                     Dummy  385      HORIZ_INTERP_TYPE                                                                       
                                                            2208        scalar   ARG,IN           395,396,397,405,406,421,425,431,43
                                                                                                  4,441,444,447,448,470,471,472     
 IVERBOSE                   Local  399      I(4)            4           scalar                    403,491                           
 J                          Local  399      I(4)            4           scalar                    472,473                           
 J1                         Local  399      I(4)            4           scalar                    425,426,435                       
 J2                         Local  399      I(4)            4           scalar                    431                               
 K                          Local  399      I(4)            4           scalar                    440,441,442,444,445,447,448,449,45
                                                                                                  1,456,457,470,471,472,473         
 M                          Local  399      I(4)            4           scalar                    418,421,423,425,427,431,434,435,44
                                                                                                  1,442,444,445,447,448,449,451,457,
                                                                                                  460,468,469,470,471,472,473,477,47
                                                                                                  9                                 
 MASK_DST                   Local  397      R(8)            8     2     0        TGT              414,423,427,435,460,469,485,498   
 MASK_IN                    Dummy  385      R(8)            8     2     1        ARG,IN           415,505                           
 MASK_OUT                   Dummy  385      R(8)            8     2     1        ARG,OUT          485,507                           
 MASK_SRC                   Local  396      R(8)            8     2     0        TGT              414,415,426,435,441,495           
 MAX_IN                     Local  400      R(8)            8           scalar                    495,504                           
 MAX_OUT                    Local  400      R(8)            8           scalar                    498,506                           
 MIN_IN                     Local  400      R(8)            8           scalar                    495,504                           
 MIN_OUT                    Local  400      R(8)            8           scalar                    498,506                           
 MISSING_VALUE              Dummy  385      R(8)            8           scalar   ARG,IN           476,477,495,498                   
 MISS_IN                    Local  399      I(4)            4           scalar                    495,505                           
 MISS_OUT                   Local  399      I(4)            4           scalar                    498,507                           
 N                          Local  399      I(4)            4           scalar                    417,421,423,425,427,431,434,435,44
                                                                                                  1,442,444,445,447,448,449,451,457,

Page 15          Source Listing                  HORIZ_INTERP_SPHERICAL
2021-06-01 08:55 Symbol Table                    horiz_interp_spherical.F90

 Name                       Object Declared Type            Bytes Dimen Elements Attributes       References                        
                                                                                                                                    
                                                                                                  460,467,469,470,471,472,473,477,47
                                                                                                  9                                 
 NLAT_IN                    Local  398      I(4)            4           scalar                    405,408                           
 NLAT_OUT                   Local  398      I(4)            4           scalar                    406,411,417,467                   
 NLON_IN                    Local  398      I(4)            4           scalar                    405,408                           
 NLON_OUT                   Local  398      I(4)            4           scalar                    406,411,418,468                   
 NUM_FOUND                  Local  398      I(4)            4           scalar                    421,422,430,440,456               
 PRESENT                    Func   403                                  scalar                    403,415,476,485,505,507           
 SIZE                       Func   395                                  scalar                    395,408,411                       
 STATS                      Subr   495                                           PRIV             45,495,498                        
 SUM                        Local  400      R(8)            8           scalar                    439,446,449,455,457               
 VERBOSE                    Dummy  385      I(4)            4           scalar   ARG,IN           403                               
 WT                         Local  395      R(8)            8     3     0                         442,445,448,449,451,457,473       

Page 16          Source Listing                  HORIZ_INTERP_SPHERICAL
2021-06-01 08:55                                 horiz_interp_spherical.F90

    518 
    519 ! </SUBROUTINE>
    520 !#######################################################################
    521   subroutine horiz_interp_spherical_wght( Interp, wt, verbose, mask_in, mask_out, missing_value)
    522     type (horiz_interp_type), intent(in)        :: Interp
    523     real, intent(out), dimension(:,:,:)         :: wt
    524     integer, intent(in),               optional :: verbose
    525     real, intent(in), dimension(:,:),  optional :: mask_in
    526     real, intent(inout), dimension(:,:), optional :: mask_out
    527     real, intent(in),                  optional :: missing_value
    528 
    529 !--- some local variables ----------------------------------------
    530     real, dimension(Interp%nlon_src, Interp%nlat_src) :: mask_src
    531     real, dimension(Interp%nlon_dst, Interp%nlat_dst) :: mask_dst
    532     integer :: nlon_in, nlat_in, nlon_out, nlat_out, num_found
    533     integer :: m, n, i, j, k, miss_in, miss_out, i1, i2, j1, j2, iverbose
    534     real    :: min_in, max_in, avg_in, min_out, max_out, avg_out, sum
    535 !-----------------------------------------------------------------
    536 
    537     iverbose = 0;  if (present(verbose)) iverbose = verbose
    538 
    539     nlon_in  = Interp%nlon_src; nlat_in  = Interp%nlat_src
    540     nlon_out = Interp%nlon_dst; nlat_out = Interp%nlat_dst
    541 
    542     mask_src = 1.0; mask_dst = 1.0
    543     if(present(mask_in)) mask_src = mask_in
    544 
    545     do n=1,nlat_out
    546        do m=1,nlon_out
    547 ! neighbors are sorted nearest to farthest
    548 ! check nearest to see if it is a land point
    549           num_found = Interp%num_found(m,n)
    550 
    551           if (num_found > num_nbrs_default) then
    552             print*,'pe=',mpp_pe(),'num_found=',num_found
    553             num_found = num_nbrs_default
    554           end if
    555 
    556           if(num_found == 0 ) then
    557              mask_dst(m,n) = 0.0
    558           else
    559              i1 = Interp%i_lon(m,n,1); j1 = Interp%j_lat(m,n,1)
    560              if (mask_src(i1,j1) .lt. 0.5) then
    561                 mask_dst(m,n) = 0.0
    562              endif
    563 
    564              if(num_found .gt. 1 ) then
    565                 i2 = Interp%i_lon(m,n,2); j2 = Interp%j_lat(m,n,2)
    566 ! compare first 2 nearest neighbors -- if they are nearly
    567 ! equidistant then use this mask for robustness
    568                 if(abs(Interp%src_dist(m,n,2)-Interp%src_dist(m,n,1)) .lt. epsln) then
    569                    if((mask_src(i1,j1) .lt. 0.5))  mask_dst(m,n) = 0.0
    570                 endif
    571              endif
    572 
    573              sum=0.0
    574              do k=1, num_found

Page 17          Source Listing                  HORIZ_INTERP_SPHERICAL_WGHT
2021-06-01 08:55                                 horiz_interp_spherical.F90

    575                 if(mask_src(Interp%i_lon(m,n,k),Interp%j_lat(m,n,k)) .lt. 0.5 ) then
    576                    wt(m,n,k) = 0.0
    577                 else
    578                    if (Interp%src_dist(m,n,k) <= epsln) then
    579                       wt(m,n,k) = large
    580                       sum = sum + large
    581                    else if(Interp%src_dist(m,n,k) <= Interp%max_src_dist ) then
    582                       wt(m,n,k) = 1.0/Interp%src_dist(m,n,k)
    583                       sum = sum+wt(m,n,k)
    584                    else
    585                       wt(m,n,k) = 0.0
    586                    endif
    587                 endif
    588              enddo
    589              if (sum > epsln) then
    590                 do k = 1, num_found
    591                    wt(m,n,k) = wt(m,n,k)/sum
    592                 enddo
    593              else
    594                 mask_dst(m,n) = 0.0
    595              endif
    596           endif
    597        enddo
    598     enddo
    599 
    600     return
    601   end subroutine horiz_interp_spherical_wght


ENTRY POINTS

  Name                                                                  
                                                                        
 horiz_interp_spherical_mod_mp_horiz_interp_spherical_wght_             

Page 18          Source Listing                  HORIZ_INTERP_SPHERICAL_WGHT
2021-06-01 08:55 Symbol Table                    horiz_interp_spherical.F90



SYMBOL CROSS REFERENCE

 Name                       Object Declared Type            Bytes Dimen Elements Attributes       References                        
                                                                                                                                    
 ABS                        Func   568                                  scalar                    568                               
 AVG_IN                     Local  534      R(8)            8           scalar                                                      
 AVG_OUT                    Local  534      R(8)            8           scalar                                                      
 HORIZ_INTERP_SPHERICAL_WGH                                                                                                         
 T                          Subr   521                                                                                              
 I                          Local  533      I(4)            4           scalar                                                      
 I1                         Local  533      I(4)            4           scalar                    559,560,569                       
 I2                         Local  533      I(4)            4           scalar                    565                               
 INTERP                     Dummy  521      HORIZ_INTERP_TYPE                                                                       
                                                            2208        scalar   ARG,IN           530,531,539,540,549,559,565,568,57
                                                                                                  5,578,581,582                     
 IVERBOSE                   Local  533      I(4)            4           scalar                    537                               
 J                          Local  533      I(4)            4           scalar                                                      
 J1                         Local  533      I(4)            4           scalar                    559,560,569                       
 J2                         Local  533      I(4)            4           scalar                    565                               
 K                          Local  533      I(4)            4           scalar                    574,575,576,578,579,581,582,583,58
                                                                                                  5,590,591                         
 M                          Local  533      I(4)            4           scalar                    546,549,557,559,561,565,568,569,57
                                                                                                  5,576,578,579,581,582,583,585,591,
                                                                                                  594                               
 MASK_DST                   Local  531      R(8)            8     2     0                         542,557,561,569,594               
 MASK_IN                    Dummy  521      R(8)            8     2     1        ARG,IN           543                               
 MASK_OUT                   Dummy  521      R(8)            8     2     1        ARG,INOUT                                          
 MASK_SRC                   Local  530      R(8)            8     2     0                         542,543,560,569,575               
 MAX_IN                     Local  534      R(8)            8           scalar                                                      
 MAX_OUT                    Local  534      R(8)            8           scalar                                                      
 MIN_IN                     Local  534      R(8)            8           scalar                                                      
 MIN_OUT                    Local  534      R(8)            8           scalar                                                      
 MISSING_VALUE              Dummy  521      R(8)            8           scalar   ARG,IN                                             
 MISS_IN                    Local  533      I(4)            4           scalar                                                      
 MISS_OUT                   Local  533      I(4)            4           scalar                                                      
 N                          Local  533      I(4)            4           scalar                    545,549,557,559,561,565,568,569,57
                                                                                                  5,576,578,579,581,582,583,585,591,
                                                                                                  594                               
 NLAT_IN                    Local  532      I(4)            4           scalar                    539                               
 NLAT_OUT                   Local  532      I(4)            4           scalar                    540,545                           
 NLON_IN                    Local  532      I(4)            4           scalar                    539                               
 NLON_OUT                   Local  532      I(4)            4           scalar                    540,546                           
 NUM_FOUND                  Local  532      I(4)            4           scalar                    549,551,552,553,556,564,574,590   
 PRESENT                    Func   537                                  scalar                    537,543                           
 SUM                        Local  534      R(8)            8           scalar                    573,580,583,589,591               
 VERBOSE                    Dummy  521      I(4)            4           scalar   ARG,IN           537                               
 WT                         Dummy  521      R(8)            8     3     1        ARG,OUT          576,579,582,583,585,591           

Page 19          Source Listing                  HORIZ_INTERP_SPHERICAL_WGHT
2021-06-01 08:55                                 horiz_interp_spherical.F90

    602 ! </SUBROUTINE>
    603 
    604 !#######################################################################
    605 ! <SUBROUTINE NAME="horiz_interp_spherical_del">
    606 
    607 !   <OVERVIEW>
    608 !     Deallocates memory used by "horiz_interp_type" variables.
    609 !     Must be called before reinitializing with horiz_interp_spherical_new.
    610 !   </OVERVIEW>
    611 !   <DESCRIPTION>
    612 !     Deallocates memory used by "horiz_interp_type" variables.
    613 !     Must be called before reinitializing with horiz_interp_spherical_new.
    614 !   </DESCRIPTION>
    615 !   <TEMPLATE>
    616 !     call horiz_interp_spherical_del ( Interp )
    617 !   </TEMPLATE>
    618 
    619 !   <INOUT NAME="Interp" TYPE="horiz_interp_type">
    620 !     A derived-type variable returned by previous call
    621 !     to horiz_interp_spherical_new. The input variable must have
    622 !     allocated arrays. The returned variable will contain
    623 !     deallocated arrays.
    624 !   </INOUT>
    625 
    626 
    627   subroutine horiz_interp_spherical_del( Interp )
    628 
    629     type (horiz_interp_type), intent(inout) :: Interp
    630 
    631     if(associated(Interp%src_dist))  deallocate(Interp%src_dist)
    632     if(associated(Interp%num_found)) deallocate(Interp%num_found)
    633     if(associated(Interp%i_lon))     deallocate(Interp%i_lon)
    634     if(associated(Interp%j_lat))     deallocate(Interp%j_lat)
    635 
    636   end subroutine horiz_interp_spherical_del

Page 20          Source Listing                  HORIZ_INTERP_SPHERICAL_DEL
2021-06-01 08:55 Entry Points                    horiz_interp_spherical.F90



ENTRY POINTS

  Name                                                                 
                                                                       
 horiz_interp_spherical_mod_mp_horiz_interp_spherical_del_             


SYMBOL CROSS REFERENCE

 Name                       Object Declared Type            Bytes Dimen Elements Attributes       References                        
                                                                                                                                    
 ASSOCIATED                 Func   631                                  scalar                    631,632,633,634                   
 HORIZ_INTERP_SPHERICAL_DEL Subr   627                                                                                              
 INTERP                     Dummy  627      HORIZ_INTERP_TYPE                                                                       
                                                            2208        scalar   ARG,INOUT        631,632,633,634                   

Page 21          Source Listing                  HORIZ_INTERP_SPHERICAL_DEL
2021-06-01 08:55                                 horiz_interp_spherical.F90

    637 ! </SUBROUTINE>
    638 
    639 !#######################################################################
    640 
    641 
    642   subroutine radial_search(theta_src,phi_src,theta_dst,phi_dst, map_src_xsize, map_src_ysize, &
    643        map_src_add, map_src_dist, num_found, num_neighbors,max_src_dist,src_is_modulo)
    644     real,    intent(in),    dimension(:)   :: theta_src, phi_src
    645     real,    intent(in),    dimension(:,:) :: theta_dst, phi_dst
    646     integer, intent(in)                    :: map_src_xsize, map_src_ysize
    647     integer, intent(out), dimension(:,:,:) :: map_src_add
    648     real,    intent(out), dimension(:,:,:) :: map_src_dist
    649     integer, intent(inout), dimension(:,:) :: num_found
    650     integer, intent(in)                    :: num_neighbors
    651     real,    intent(in)                    :: max_src_dist
    652     logical, intent(in)                    :: src_is_modulo
    653 
    654 !---------- local variables ----------------------------------------
    655     integer, parameter :: max_nbrs = 50
    656     integer :: i, j, jj, i0, j0, n, l,i_left, i_right
    657     integer :: map_dst_xsize, map_dst_ysize
    658     integer :: i_left1, i_left2, i_right1, i_right2
    659     integer :: map_src_size, step, step_size, bound, bound_start, bound_end
    660     logical :: continue_search, result, continue_radial_search
    661     real    :: d, res
    662 !------------------------------------------------------------------
    663     map_dst_xsize=size(theta_dst,1);map_dst_ysize=size(theta_dst,2)
    664     map_src_size = map_src_xsize*map_src_ysize
    665 
    666     do j=1,map_dst_ysize
    667        do i=1,map_dst_xsize
    668           continue_search=.true.
    669           step = 1
    670           step_size = sqrt(real(map_src_size) )
    671           do while (continue_search .and. step_size > 0)
    672              do while (step <= map_src_size .and. continue_search)
    673 ! count land points as nearest neighbors
    674                 d = spherical_distance(theta_dst(i,j),phi_dst(i,j),theta_src(step),phi_src(step))
    675                 if (d <= max_src_dist) then
    676                    result = update_dest_neighbors(map_src_add(i,j,:),map_src_dist(i,j,:), &
    677                         step,d, num_found(i,j), num_neighbors )
    678                    if (result) then
    679                       n = 0
    680                       i0 = mod(step,map_src_xsize)
    681 
    682                       if (i0 == 0) i0 = map_src_xsize
    683                       res = float(step)/float(map_src_xsize)
    684                       j0 = ceiling(res)
    685                       continue_radial_search = .true.
    686                       do while (continue_radial_search)
    687                          continue_radial_search = .false.
    688                          n = n+1 ! radial counter
    689                          if(n > max_nbrs) exit
    690 ! ************** left boundary *******************************
    691                          i_left = i0-n
    692                          if (i_left <= 0) then
    693                             if (src_is_modulo) then

Page 22          Source Listing                  RADIAL_SEARCH
2021-06-01 08:55                                 horiz_interp_spherical.F90

    694                                i_left = map_src_xsize + i_left
    695                             else
    696                                i_left = 1
    697                             endif
    698                          endif
    699 
    700                          do l = 0, 2*n
    701                             jj = j0 - n - 1 + l
    702                             if( jj < 0) then
    703                                bound = ( 1 - jj )*map_src_xsize - i_left
    704                             else if ( jj >= map_src_ysize ) then
    705                                bound = ( 2*map_src_ysize - jj ) * map_src_xsize - i_left
    706                             else
    707                                bound = jj * map_src_xsize + i_left
    708                             endif
    709 
    710                             d = spherical_distance(theta_dst(i,j),phi_dst(i,j),theta_src(bound),phi_src(bound))
    711                             if(d<=max_src_dist) then
    712                                result = update_dest_neighbors(map_src_add(i,j,:),map_src_dist(i,j,:), &
    713                                     bound,d, num_found(i,j), num_neighbors)
    714                                if (result) continue_radial_search = .true.
    715                             endif
    716                          enddo
    717 
    718 ! ***************************right boundary *******************************
    719                          i_right = i0+n
    720                          if (i_right > map_src_xsize) then
    721                             if (src_is_modulo) then
    722                                i_right = i_right - map_src_xsize
    723                             else
    724                                i_right = map_src_xsize
    725                             endif
    726                          endif
    727 
    728                          do l = 0, 2*n
    729                             jj = j0 - n - 1 + l
    730                             if( jj < 0) then
    731                                bound = ( 1 - jj )*map_src_xsize - i_right
    732                             else if ( jj >= map_src_ysize ) then
    733                                bound = ( 2*map_src_ysize - jj) * map_src_xsize - i_right
    734 
    735                             else
    736                                bound = jj * map_src_xsize + i_right
    737                             endif
    738 
    739                             d = spherical_distance(theta_dst(i,j),phi_dst(i,j),theta_src(bound),phi_src(bound))
    740                             if(d<=max_src_dist) then
    741                                result = update_dest_neighbors(map_src_add(i,j,:),map_src_dist(i,j,:), &
    742                                     bound,d, num_found(i,j), num_neighbors)
    743                                if (result) continue_radial_search = .true.
    744                             endif
    745                          enddo
    746 
    747 ! ************************* bottom boundary **********************************
    748                          i_left2 = 0
    749                          if( i_left > i_right) then
    750                             i_left1 = 1

Page 23          Source Listing                  RADIAL_SEARCH
2021-06-01 08:55                                 horiz_interp_spherical.F90

    751                             i_right1 = i_right
    752                             i_left2 = i_left
    753                             i_right2 = map_src_xsize
    754                          else
    755                             i_left1 = i_left
    756                             i_right1 = i_right
    757                          endif
    758 
    759                          jj = j0 - n - 1
    760                          if( jj < 0 ) then
    761                             bound_start = ( 1 - jj)*map_src_xsize - i_right1
    762                             bound_end   = ( 1 - jj)*map_src_xsize - i_left1
    763                          else
    764                             bound_start = jj * map_src_xsize + i_left1
    765                             bound_end = jj * map_src_xsize + i_right1
    766                          endif
    767 
    768                          bound = bound_start
    769                          do while (bound <= bound_end)
    770                             d = spherical_distance(theta_dst(i,j),phi_dst(i,j),theta_src(bound),phi_src(bound))
    771                             if(d<=max_src_dist) then
    772                                result = update_dest_neighbors(map_src_add(i,j,:),map_src_dist(i,j,:), &
    773                                     bound,d, num_found(i,j), num_neighbors)
    774                                if (result) continue_radial_search = .true.
    775                             endif
    776                             bound = bound + 1
    777 
    778                          enddo
    779 
    780                          if(i_left2 > 0 ) then
    781                             if( jj < 0 ) then
    782                                bound_start = ( 1 - jj)*map_src_xsize - i_right2
    783                                bound_end   = ( 1 - jj)*map_src_xsize - i_left2
    784                             else
    785                                bound_start = jj * map_src_xsize + i_left2
    786                                bound_end = jj * map_src_xsize + i_right2
    787                             endif
    788 
    789                             bound = bound_start
    790                             do while (bound <= bound_end)
    791                                d = spherical_distance(theta_dst(i,j),phi_dst(i,j),theta_src(bound),phi_src(bound))
    792                                if(d<=max_src_dist) then
    793                                   result = update_dest_neighbors(map_src_add(i,j,:),map_src_dist(i,j,:), &
    794                                        bound,d, num_found(i,j), num_neighbors)
    795                                   if (result) continue_radial_search = .true.
    796                                endif
    797                                bound = bound + 1
    798                             enddo
    799                          endif
    800 
    801 ! ************************** top boundary ************************************
    802                          jj = j0 + n - 1
    803                          if( jj >= map_src_ysize) then
    804                             bound_start = ( 2*map_src_ysize - jj ) * map_src_xsize - i_right1
    805                             bound_end   = ( 2*map_src_ysize - jj ) * map_src_xsize - i_left1
    806                          else
    807                             bound_start = jj * map_src_xsize + i_left1

Page 24          Source Listing                  RADIAL_SEARCH
2021-06-01 08:55                                 horiz_interp_spherical.F90

    808                             bound_end = jj * map_src_xsize + i_right1
    809                          endif
    810 
    811                          bound = bound_start
    812                          do while (bound <= bound_end)
    813                             d = spherical_distance(theta_dst(i,j),phi_dst(i,j),theta_src(bound),phi_src(bound))
    814                             if(d<=max_src_dist) then
    815                                result = update_dest_neighbors(map_src_add(i,j,:),map_src_dist(i,j,:), &
    816                                     bound,d, num_found(i,j), num_neighbors)
    817                                if (result) continue_radial_search = .true.
    818                             endif
    819                             bound = bound + 1
    820                          enddo
    821 
    822                          if(i_left2 > 0) then
    823                             if( jj >= map_src_ysize) then
    824                                bound_start = ( 2*map_src_ysize - jj ) * map_src_xsize - i_right2
    825                                bound_end   = ( 2*map_src_ysize - jj ) * map_src_xsize - i_left2
    826                             else
    827                                bound_start = jj * map_src_xsize + i_left2
    828                                bound_end = jj * map_src_xsize + i_right2
    829                             endif
    830 
    831                             bound = bound_start
    832                             do while (bound <= bound_end)
    833                                d = spherical_distance(theta_dst(i,j),phi_dst(i,j),theta_src(bound),phi_src(bound))
    834                                if(d<=max_src_dist) then
    835                                   result = update_dest_neighbors(map_src_add(i,j,:),map_src_dist(i,j,:), &
    836                                        bound,d, num_found(i,j), num_neighbors)
    837                                   if (result) continue_radial_search = .true.
    838                                endif
    839                                bound = bound + 1
    840                             enddo
    841                          endif
    842 
    843                       enddo
    844                       continue_search = .false. ! stop looking
    845                    endif
    846                 endif
    847                 step=step+step_size
    848              enddo ! search loop
    849              step = 1
    850              step_size = step_size/2
    851           enddo
    852        enddo
    853     enddo
    854 
    855     return
    856 
    857   end subroutine radial_search

Page 25          Source Listing                  RADIAL_SEARCH
2021-06-01 08:55 Entry Points                    horiz_interp_spherical.F90



ENTRY POINTS

  Name                                                    
                                                          
 horiz_interp_spherical_mod_mp_radial_search_             


SYMBOL CROSS REFERENCE

 Name                       Object Declared Type            Bytes Dimen Elements Attributes       References                        
                                                                                                                                    
 BOUND                      Local  659      I(4)            4           scalar                    703,705,707,710,713,731,733,736,73
                                                                                                  9,742,768,769,770,773,776,789,790,
                                                                                                  791,794,797,811,812,813,816,819,83
                                                                                                  1,832,833,836,839                 
 BOUND_END                  Local  659      I(4)            4           scalar                    762,765,769,783,786,790,805,808,81
                                                                                                  2,825,828,832                     
 BOUND_START                Local  659      I(4)            4           scalar                    761,764,768,782,785,789,804,807,81
                                                                                                  1,824,827,831                     
 CEILING                    Func   684                                  scalar                    684                               
 CONTINUE_RADIAL_SEARCH     Local  660      L(4)            4           scalar                    685,686,687,714,743,774,795,817,83
                                                                                                  7                                 
 CONTINUE_SEARCH            Local  660      L(4)            4           scalar                    668,671,672,844                   
 D                          Local  661      R(8)            8           scalar                    674,675,677,710,711,713,739,740,74
                                                                                                  2,770,771,773,791,792,794,813,814,
                                                                                                  816,833,834,836                   
 FLOAT                      Func   683                                  scalar                    683                               
 I                          Local  656      I(4)            4           scalar                    667,674,676,677,710,712,713,739,74
                                                                                                  1,742,770,772,773,791,793,794,813,
                                                                                                  815,816,833,835,836               
 I0                         Local  656      I(4)            4           scalar                    680,682,691,719                   
 I_LEFT                     Local  656      I(4)            4           scalar                    691,692,694,696,703,705,707,749,75
                                                                                                  2,755                             
 I_LEFT1                    Local  658      I(4)            4           scalar                    750,755,762,764,805,807           
 I_LEFT2                    Local  658      I(4)            4           scalar                    748,752,780,783,785,822,825,827   
 I_RIGHT                    Local  656      I(4)            4           scalar                    719,720,722,724,731,733,736,749,75
                                                                                                  1,756                             
 I_RIGHT1                   Local  658      I(4)            4           scalar                    751,756,761,765,804,808           
 I_RIGHT2                   Local  658      I(4)            4           scalar                    753,782,786,824,828               
 J                          Local  656      I(4)            4           scalar                    666,674,676,677,710,712,713,739,74
                                                                                                  1,742,770,772,773,791,793,794,813,
                                                                                                  815,816,833,835,836               
 J0                         Local  656      I(4)            4           scalar                    684,701,729,759,802               
 JJ                         Local  656      I(4)            4           scalar                    701,702,703,704,705,707,729,730,73
                                                                                                  1,732,733,736,759,760,761,762,764,
                                                                                                  765,781,782,783,785,786,802,803,80
                                                                                                  4,805,807,808,823,824,825,827,828 
 L                          Local  656      I(4)            4           scalar                    700,701,728,729                   
 MAP_DST_XSIZE              Local  657      I(4)            4           scalar                    663,667                           
 MAP_DST_YSIZE              Local  657      I(4)            4           scalar                    663,666                           
 MAP_SRC_ADD                Dummy  643      I(4)            4     3     1        ARG,OUT          676,712,741,772,793,815,835       
 MAP_SRC_DIST               Dummy  643      R(8)            8     3     1        ARG,OUT          676,712,741,772,793,815,835       
 MAP_SRC_SIZE               Local  659      I(4)            4           scalar                    664,670,672                       
 MAP_SRC_XSIZE              Dummy  642      I(4)            4           scalar   ARG,IN           664,680,682,683,694,703,705,707,72
                                                                                                  0,722,724,731,733,736,753,761,762,

Page 26          Source Listing                  RADIAL_SEARCH
2021-06-01 08:55 Symbol Table                    horiz_interp_spherical.F90

 Name                       Object Declared Type            Bytes Dimen Elements Attributes       References                        
                                                                                                                                    
                                                                                                  764,765,782,783,785,786,804,805,80
                                                                                                  7,808,824,825,827,828             
 MAP_SRC_YSIZE              Dummy  642      I(4)            4           scalar   ARG,IN           664,704,705,732,733,803,804,805,82
                                                                                                  3,824,825                         
 MAX_NBRS                   Param  655      I(4)            4           scalar                    689                               
 MAX_SRC_DIST               Dummy  643      R(8)            8           scalar   ARG,IN           675,711,740,771,792,814,834       
 MOD                        Func   680                                  scalar                    680                               
 N                          Local  656      I(4)            4           scalar                    679,688,689,691,700,701,719,728,72
                                                                                                  9,759,802                         
 NUM_FOUND                  Dummy  643      I(4)            4     2     1        ARG,INOUT        677,713,742,773,794,816,836       
 NUM_NEIGHBORS              Dummy  643      I(4)            4           scalar   ARG,IN           677,713,742,773,794,816,836       
 PHI_DST                    Dummy  642      R(8)            8     2     1        ARG,IN           674,710,739,770,791,813,833       
 PHI_SRC                    Dummy  642      R(8)            8     1     1        ARG,IN           674,710,739,770,791,813,833       
 RADIAL_SEARCH              Subr   642                                                            306                               
 REAL                       Func   670                                  scalar                    670                               
 RES                        Local  661      R(8)            8           scalar                    683,684                           
 RESULT                     Local  660      L(4)            4           scalar                    676,678,712,714,741,743,772,774,79
                                                                                                  3,795,815,817,835,837             
 SIZE                       Func   663                                  scalar                    663                               
 SPHERICAL_DISTANCE@0       Local  674      R(8)            8           scalar                                                      
 SQRT                       Func   670                                  scalar                    670                               
 SRC_IS_MODULO              Dummy  643      L(4)            4           scalar   ARG,IN           693,721                           
 STEP                       Local  659      I(4)            4           scalar                    669,672,674,677,680,683,847,849   
 STEP_SIZE                  Local  659      I(4)            4           scalar                    670,671,847,850                   
 THETA_DST                  Dummy  642      R(8)            8     2     1        ARG,IN           663,674,710,739,770,791,813,833   
 THETA_SRC                  Dummy  642      R(8)            8     1     1        ARG,IN           674,710,739,770,791,813,833       
 UPDATE_DEST_NEIGHBORS@0    Local  676      L(4)            4           scalar                                                      

Page 27          Source Listing                  RADIAL_SEARCH
2021-06-01 08:55                                 horiz_interp_spherical.F90

    858 
    859 
    860 !#####################################################################
    861 
    862   function update_dest_neighbors(map_src_add, map_src_dist, src_add,d, num_found, min_nbrs)
    863 
    864     integer, intent(inout), dimension(:) :: map_src_add
    865     real, intent(inout),    dimension(:) :: map_src_dist
    866     integer, intent(in)                  :: src_add
    867     real, intent(in)                     :: d
    868     integer, intent(inout)               :: num_found
    869     integer, intent(in)                  :: min_nbrs
    870 
    871     logical :: update_dest_neighbors, already_exist = .false.
    872 
    873     integer :: n,m
    874 
    875     update_dest_neighbors = .false.
    876 
    877     n = 0
    878     NLOOP : do while ( n .le. num_found )
    879        n = n + 1
    880        DIST_CHK : if (d .le. map_src_dist(n)) then
    881           do m=n,num_found
    882              if (src_add == map_src_add(m)) then
    883                 already_exist = .true.
    884                 exit NLOOP
    885              endif
    886           enddo
    887           if(num_found < max_neighbors) then
    888              num_found = num_found + 1
    889           else
    890              call mpp_error(FATAL,'update_dest_neighbors: '// &
    891                   'number of neighbor points found is greated than maxium neighbor points' )
    892           endif
    893           do m=num_found,n+1,-1
    894              map_src_add(m) = map_src_add(m-1)
    895              map_src_dist(m) = map_src_dist(m-1)
    896           enddo
    897           map_src_add(n) = src_add
    898           map_src_dist(n) = d
    899           update_dest_neighbors = .true.
    900           if( num_found > min_nbrs ) then
    901              if( map_src_dist(num_found) > map_src_dist(num_found-1) ) then
    902                 num_found = num_found - 1
    903              endif
    904              if( map_src_dist(min_nbrs+1) > map_src_dist(min_nbrs) ) then
    905                 num_found = min_nbrs
    906              endif
    907           endif
    908           exit NLOOP ! n loop
    909        endif DIST_CHK
    910     end do NLOOP
    911     if(already_exist) return
    912 
    913     if( .not. update_dest_neighbors ) then
    914        if( num_found < min_nbrs ) then

Page 28          Source Listing                  UPDATE_DEST_NEIGHBORS
2021-06-01 08:55                                 horiz_interp_spherical.F90

    915           num_found               = num_found + 1
    916           update_dest_neighbors   = .true.
    917           map_src_add(num_found)  = src_add
    918           map_src_dist(num_found) = d
    919        endif
    920     endif
    921 
    922 
    923     return
    924 
    925   end function update_dest_neighbors


ENTRY POINTS

  Name                                                            
                                                                  
 horiz_interp_spherical_mod_mp_update_dest_neighbors_             


SYMBOL CROSS REFERENCE

 Name                       Object Declared Type            Bytes Dimen Elements Attributes       References                        
                                                                                                                                    
 ALREADY_EXIST              Local  871      L(4)            4           scalar                    871,883,911                       
 D                          Dummy  862      R(8)            8           scalar   ARG,IN           880,898,918                       
 DIST_CHK                   Label  880                                  scalar                    909                               
 M                          Local  873      I(4)            4           scalar                    881,882,893,894,895               
 MAP_SRC_ADD                Dummy  862      I(4)            4     1     1        ARG,INOUT        882,894,897,917                   
 MAP_SRC_DIST               Dummy  862      R(8)            8     1     1        ARG,INOUT        880,895,898,901,904,918           
 MIN_NBRS                   Dummy  862      I(4)            4           scalar   ARG,IN           900,904,905,914                   
 N                          Local  873      I(4)            4           scalar                    877,878,879,880,881,893,897,898   
 NLOOP                      Label  878                                  scalar                    884,908,910                       
 NUM_FOUND                  Dummy  862      I(4)            4           scalar   ARG,INOUT        878,881,887,888,893,900,901,902,90
                                                                                                  5,914,915,917,918                 
 SRC_ADD                    Dummy  862      I(4)            4           scalar   ARG,IN           882,897,917                       
 UPDATE_DEST_NEIGHBORS      Func   862      L(4)            4           scalar                    676,712,741,772,793,815,835,875,89
                                                                                                  9,913,916,1017                    

Page 29          Source Listing                  UPDATE_DEST_NEIGHBORS
2021-06-01 08:55                                 horiz_interp_spherical.F90

    926 
    927 !########################################################################
    928 !  function spherical_distance(theta1,phi1,theta2,phi2)
    929 
    930 !    real, intent(in) :: theta1, phi1, theta2, phi2
    931 !    real :: spherical_distance
    932 
    933 !    real :: r1(3), r2(3), cross(3), s, dot, ang
    934 
    935 ! this is a simple, enough way to calculate distance on the sphere
    936 ! first, construct cartesian vectors r1 and r2
    937 ! then calculate the cross-product which is proportional to the area
    938 ! between the 2 vectors.  The angular distance is arcsin of the
    939 ! distancealong the sphere
    940 !
    941 ! theta is longitude and phi is latitude
    942 !
    943 
    944 
    945 !    r1(1) = cos(theta1)*cos(phi1);r1(2)=sin(theta1)*cos(phi1);r1(3)=sin(phi1)
    946 !    r2(1) = cos(theta2)*cos(phi2);r2(2)=sin(theta2)*cos(phi2);r2(3)=sin(phi2)
    947 
    948 !    cross(1) = r1(2)*r2(3)-r1(3)*r2(2)
    949 !    cross(2) = r1(3)*r2(1)-r1(1)*r2(3)
    950 !    cross(3) = r1(1)*r2(2)-r1(2)*r2(1)
    951 
    952 !    s = sqrt(cross(1)**2.+cross(2)**2.+cross(3)**2.)
    953 
    954 !    s = min(s,1.0-epsln)
    955 
    956 !    dot = r1(1)*r2(1) + r1(2)*r2(2) + r1(3)*r2(3)
    957 
    958 !    if (dot > 0) then
    959 !       ang = asin(s)
    960 !    else if (dot < 0) then
    961 !       ang = pi + asin(s)  !?  original is pi - asin(s)
    962 !    else
    963 !       ang = pi/2.
    964 !    endif
    965 
    966 !    spherical_distance = abs(ang) ! in radians
    967 
    968 !    return
    969 
    970 !  end function spherical_distance
    971 ! The great cycle distance
    972   function spherical_distance(theta1,phi1,theta2,phi2)
    973 
    974     real, intent(in) :: theta1, phi1, theta2, phi2
    975     real :: spherical_distance, dot
    976 
    977     if(theta1 == theta2 .and. phi1 == phi2) then
    978         spherical_distance = 0.0
    979         return
    980     endif
    981 
    982     dot = cos(phi1)*cos(phi2)*cos(theta1-theta2) + sin(phi1)*sin(phi2)

Page 30          Source Listing                  SPHERICAL_DISTANCE
2021-06-01 08:55                                 horiz_interp_spherical.F90

    983     if(dot > 1. ) dot = 1.
    984     if(dot < -1.) dot = -1.
    985     spherical_distance = acos(dot)
    986 
    987     return
    988 
    989   end function spherical_distance


ENTRY POINTS

  Name                                                         
                                                               
 horiz_interp_spherical_mod_mp_spherical_distance_             


SYMBOL CROSS REFERENCE

 Name                       Object Declared Type            Bytes Dimen Elements Attributes       References                        
                                                                                                                                    
 ACOS                       Func   985                                  scalar                    985                               
 COS                        Func   982                                  scalar                    982                               
 DOT                        Local  975      R(8)            8           scalar                    982,983,984,985                   
 PHI1                       Dummy  972      R(8)            8           scalar   ARG,IN           977,982                           
 PHI2                       Dummy  972      R(8)            8           scalar   ARG,IN           977,982                           
 SIN                        Func   982                                  scalar                    982                               
 SPHERICAL_DISTANCE         Func   972      R(8)            8           scalar                    674,710,739,770,791,813,833,978,98
                                                                                                  5,1015                            
 THETA1                     Dummy  972      R(8)            8           scalar   ARG,IN           977,982                           
 THETA2                     Dummy  972      R(8)            8           scalar   ARG,IN           977,982                           

Page 31          Source Listing                  SPHERICAL_DISTANCE
2021-06-01 08:55                                 horiz_interp_spherical.F90

    990 
    991 
    992 !#######################################################################
    993 
    994   subroutine full_search(theta_src,phi_src,theta_dst,phi_dst,map_src_add, map_src_dist,num_found, &
    995                          num_neighbors,max_src_dist)
    996     real,    intent(in),    dimension(:)   :: theta_src, phi_src
    997     real,    intent(in),    dimension(:,:) :: theta_dst, phi_dst
    998     integer, intent(out), dimension(:,:,:) :: map_src_add
    999     real,    intent(out), dimension(:,:,:) :: map_src_dist
   1000     integer, intent(out), dimension(:,:)   :: num_found
   1001     integer, intent(in)                    :: num_neighbors
   1002     real, intent(in)                       :: max_src_dist
   1003 
   1004     integer :: i,j,map_src_size, step
   1005     integer :: map_dst_xsize,map_dst_ysize
   1006     real    :: d
   1007     logical :: found
   1008 
   1009     map_dst_xsize=size(theta_dst,1);map_dst_ysize=size(theta_dst,2)
   1010     map_src_size =size(theta_src(:))
   1011 
   1012     do j=1,map_dst_ysize
   1013        do i=1,map_dst_xsize
   1014           do step = 1, map_src_size
   1015              d = spherical_distance(theta_dst(i,j),phi_dst(i,j),theta_src(step),phi_src(step))
   1016              if( d <= max_src_dist) then
   1017                 found = update_dest_neighbors(map_src_add(i,j,:),map_src_dist(i,j,:), &
   1018                      step,d,num_found(i,j), num_neighbors )
   1019              endif
   1020           enddo
   1021        enddo
   1022     enddo
   1023 
   1024   end subroutine full_search

Page 32          Source Listing                  FULL_SEARCH
2021-06-01 08:55 Entry Points                    horiz_interp_spherical.F90



ENTRY POINTS

  Name                                                  
                                                        
 horiz_interp_spherical_mod_mp_full_search_             


SYMBOL CROSS REFERENCE

 Name                       Object Declared Type            Bytes Dimen Elements Attributes       References                        
                                                                                                                                    
 D                          Local  1006     R(8)            8           scalar                    1015,1016,1018                    
 FOUND                      Local  1007     L(4)            4           scalar                    1017                              
 FULL_SEARCH                Subr   994                                                            309                               
 I                          Local  1004     I(4)            4           scalar                    1013,1015,1017,1018               
 J                          Local  1004     I(4)            4           scalar                    1012,1015,1017,1018               
 MAP_DST_XSIZE              Local  1005     I(4)            4           scalar                    1009,1013                         
 MAP_DST_YSIZE              Local  1005     I(4)            4           scalar                    1009,1012                         
 MAP_SRC_ADD                Dummy  994      I(4)            4     3     1        ARG,OUT          1017                              
 MAP_SRC_DIST               Dummy  994      R(8)            8     3     1        ARG,OUT          1017                              
 MAP_SRC_SIZE               Local  1004     I(4)            4           scalar                    1010,1014                         
 MAX_SRC_DIST               Dummy  995      R(8)            8           scalar   ARG,IN           1016                              
 NUM_FOUND                  Dummy  994      I(4)            4     2     1        ARG,OUT          1018                              
 NUM_NEIGHBORS              Dummy  995      I(4)            4           scalar   ARG,IN           1018                              
 PHI_DST                    Dummy  994      R(8)            8     2     1        ARG,IN           1015                              
 PHI_SRC                    Dummy  994      R(8)            8     1     1        ARG,IN           1015                              
 SIZE                       Func   1009                                 scalar                    1009,1010                         
 STEP                       Local  1004     I(4)            4           scalar                    1014,1015,1018                    
 THETA_DST                  Dummy  994      R(8)            8     2     1        ARG,IN           1009,1015                         
 THETA_SRC                  Dummy  994      R(8)            8     1     1        ARG,IN           1010,1015                         

Page 33          Source Listing                  FULL_SEARCH
2021-06-01 08:55                                 horiz_interp_spherical.F90

   1025 
   1026 !#######################################################################
   1027 
   1028 
   1029 end module horiz_interp_spherical_mod


SYMBOL CROSS REFERENCE

 Name                       Object Declared Type            Bytes Dimen Elements Attributes       References                        
                                                                                                                                    
 CONSTANTS_MOD              Module 44                                                             44                                
 FMS_MOD                    Module 42                                                             42,43                             
 HORIZ_INTERP_SPHERICAL     Subr   51                                                             51                                
 HORIZ_INTERP_SPHERICAL_DEL Subr   51                                                             51                                
 HORIZ_INTERP_SPHERICAL_INI                                                                                                         
 T                          Subr   52                                                             52                                
 HORIZ_INTERP_SPHERICAL_MOD Module 20                                                                                               
 HORIZ_INTERP_SPHERICAL_NEW Subr   51                                                             51                                
 HORIZ_INTERP_SPHERICAL_WGH                                                                                                         
 T                          Subr   52                                                             52                                
 HORIZ_INTERP_TYPE_MOD      Module 45                                                             45                                
 MPP_MOD                    Module 39                                                             39,40,41                          
 STDOUT                     Func   39       I(4)            4           scalar   PRIV             39                                
 WARNING                    Param  39       I(4)            4           scalar   PRIV             39                                

Page 34          Source Listing                  FULL_SEARCH
2021-06-01 08:55 Subprograms/Common Blocks       horiz_interp_spherical.F90



SUBPROGRAMS/COMMON BLOCKS

 Name                       Object Declared Type            Bytes Dimen Elements Attributes       References                        
                                                                                                                                    
 FULL_SEARCH                Subr   994                                                            309                               
 HORIZ_INTERP_SPHERICAL     Subr   385                                                                                              
 HORIZ_INTERP_SPHERICAL_DEL Subr   627                                                                                              
 HORIZ_INTERP_SPHERICAL_INI                                                                                                         
 T                          Subr   122                                                                                              
 HORIZ_INTERP_SPHERICAL_MOD Module 20                                                                                               
 HORIZ_INTERP_SPHERICAL_NEW Subr   192                                                                                              
 HORIZ_INTERP_SPHERICAL_WGH                                                                                                         
 T                          Subr   521                                                                                              
 RADIAL_SEARCH              Subr   642                                                            306                               
 SPHERICAL_DISTANCE         Func   972      R(8)            8           scalar                    674,710,739,770,791,813,833,978,98
                                                                                                  5,1015                            
 UPDATE_DEST_NEIGHBORS      Func   862      L(4)            4           scalar                    676,712,741,772,793,815,835,875,89
                                                                                                  9,913,916,1017                    

COMPILER OPTIONS BEING USED

       -align noall                          -align nonone
       -align nocommons                      -align nodcommons
       -align noqcommons                     -align nozcommons
       -align records                        -align nosequence
       -align norec1byte                     -align norec2byte
       -align norec4byte                     -align norec8byte
       -align norec16byte                    -align norec32byte
       -align norec64byte                    -align noarray8byte
       -align noarray16byte                  -align noarray32byte
       -align noarray64byte                  -align noarray128byte
       -align noarray256byte                 -altparam
       -assume accuracy_sensitive            -assume nobscc
       -assume nobuffered_io                 -assume nobuffered_stdout
       -assume byterecl                      -assume nocontiguous_assumed_shape
       -assume nocontiguous_pointer          -assume cc_omp
       -assume nocstring                     -assume nodummy_aliases
       -assume nofpe_summary                 -assume noieee_fpe_flags
       -assume nominus0                      -assume noold_boz
       -assume old_complex_align             -assume old_unit_star
       -assume old_inquire_recl              -assume old_ldout_format
       -assume old_ldout_zero                -assume noold_logical_assign
       -assume noold_logical_ldio            -assume old_maxminloc
       -assume old_xor                       -assume noprotect_allocates
       -assume protect_constants             -assume noprotect_parens
       -assume split_common                  -assume source_include
       -assume nostd_intent_in               -assume std_minus0_rounding
       -assume nostd_mod_proc_name           -assume std_value
       -assume realloc_lhs                   -assume underscore
       -assume no2underscores                -assume norecursion
       -auto                            no   -auto_scalar
  no   -bintext                              -ccdefault default
       -check noarg_temp_created             -check noassume
       -check nobounds                       -check nocontiguous
       -check noformat                       -check nooutput_conversion

Page 35          Source Listing                  FULL_SEARCH
2021-06-01 08:55                                 horiz_interp_spherical.F90

       -check nooverflow                     -check nopointers
       -check noshape                        -check nostack
       -check nouninitialized                -check noudio_iostat
       -coarray-num-procs 0             no   -coarray-config-file
       -convert native                       -cross_reference
       -D __INTEL_COMPILER=1910              -D __INTEL_COMPILER_UPDATE=0
       -D __unix__                           -D __unix
       -D __linux__                          -D __linux
       -D __gnu_linux__                      -D unix
       -D linux                              -D __ELF__
       -D __x86_64                           -D __x86_64__
       -D __amd64                            -D __amd64__
       -D __INTEL_COMPILER_BUILD_DATE=20191121       -D _OPENMP=201611
       -D __INTEL_OFFLOAD                    -D __MMX__
       -D __SSE__                            -D __SSE_MATH__
       -D __SSE2__                           -D __SSE2_MATH__
       -D __pentium4                         -D __pentium4__
       -D __tune_pentium4__                  -D PACKAGE_NAME='"GFDL FMS Library"'
       -D PACKAGE_TARNAME='"FMS"'            -D PACKAGE_VERSION='"2021.02.0"'
       -D PACKAGE_STRING='"GFDL FMS Library 2021.02.0"'       -D PACKAGE_BUGREPORT='"gfdl.climate.model.info@noaa.gov"'
       -D PACKAGE_URL='"https://www.gfdl.noaa.gov/fms"'       -D PACKAGE='"FMS"'
       -D VERSION='"2021.02.0"'              -D STDC_HEADERS=1
       -D HAVE_SYS_TYPES_H=1                 -D HAVE_SYS_STAT_H=1
       -D HAVE_STDLIB_H=1                    -D HAVE_STRING_H=1
       -D HAVE_MEMORY_H=1                    -D HAVE_STRINGS_H=1
       -D HAVE_INTTYPES_H=1                  -D HAVE_STDINT_H=1
       -D HAVE_UNISTD_H=1                    -D HAVE_DLFCN_H=1
       -D LT_OBJDIR='".libs/"'               -D HAVE_MPI_H=1
       -D HAVE_NETCDF_H=1                    -D HAVE_SCHED_GETAFFINITY=1
       -D HAVE_MOD_MPI=1                     -D HAVE_MOD_NETCDF=1
       -D HAVE_CRAY_POINTER=1                -D HAVE_QUAD_PRECISION=1
       -D HAVE_INTERNAL_NML=1                -D use_netCDF=1
       -D use_libMPI=1                       -D INTERNAL_FILE_NML
       -double_size 64                  no   -d_lines
  no   -Qdyncom                              -error_limit 30
  no   -f66                             no   -f77rtl
  no   -fast                                 -fpscomp nofilesfromcmd
       -fpscomp nogeneral                    -fpscomp noioformat
       -fpscomp noldio_spacing               -fpscomp nologicals
  no   -fpconstant                           -fpe3
       -fprm nearest                         -ftz
       -fp_model noprecise                   -fp_model fast
       -fp_model nostrict                    -fp_model nosource
       -fp_model nodouble                    -fp_model noextended
       -fp_model novery_fast                 -fp_model noexcept
       -fp_model nono_except                 -fp_modbits nofp_contract
       -fp_modbits nono_fp_contract          -fp_modbits nofenv_access
       -fp_modbits nono_fenv_access          -fp_modbits nocx_limited_range
       -fp_modbits nono_cx_limited_range       -fp_modbits noprec_div
       -fp_modbits nono_prec_div             -fp_modbits noprec_sqrt
       -fp_modbits nono_prec_sqrt            -fp_modbits ftz
       -fp_modbits nono_ftz                  -fp_modbits nointrin_limited_range
       -fp_modbits nono_intrin_limited_range       -fp_modbits notrunc_compares
       -fp_modbits nono_trunc_compares       -fp_modbits noieee_nan_compares
       -fp_modbits nono_ieee_nan_compares       -fp_modbits honor_f32_conversion
       -fp_modbits nono_honor_f32_conversion       -fp_modbits honor_f64_conversion
       -fp_modbits nono_honor_f64_conversion       -fp_modbits nono_x87_copy

Page 36          Source Listing                  FULL_SEARCH
2021-06-01 08:55                                 horiz_interp_spherical.F90

       -fp_modbits nono_no_x87_copy          -fp_modbits noexception_semantics
       -fp_modbits nono_exception_semantics       -fp_modbits noprecise_libm_functions
       -fp_modbits nono_precise_libm_functions       -heap_arrays 0
  no   -threadprivate_compat                 -free
       -g2                                   -iface nomixed_str_len_arg
       -iface nono_mixed_str_len_arg         -init noarrays
       -init nohuge                          -init noinfinity
       -init nominus_huge                    -init nominus_infinity
       -init nominus_tiny                    -init nonan
       -init nosnan                          -init notiny
       -init nozero                     no   -intconstant
       -integer_size 32                 no   -mixed_str_len_arg
       -module ../.mods                      -names lowercase
  no   -noinclude                       no   -o
       -offload-build=host                   -openmp
       -openmp-simd                          -openmp-offload
       -O0                              no   -pad_source
       -real_size 64                    no   -recursive
       -reentrancy threaded                  -vec=simd
       -show nofullpath                      -show noinclude
       -show map                             -show options
  no   -syntax_only                     no   -threadcom
  no   -U                               no   -vms
       -w noall                              -w nonone
       -w noalignments                       -w nodeclarations
       -w noexternals                        -w nogeneral
       -w noignore_bounds                    -w noignore_loc
       -w nointerfaces                       -w noshape
       -w notruncated_source                 -w nouncalled
       -w nouninitialized                    -w nounused
       -w nousage                       no   -wrap-margins

       -includepath : /opt/netcdf/4.6.1/INTEL/include/,/opt/intel/2020/compilers_and_libraries/linux/pstl/include/,
           /opt/intel/2020/compilers_and_libraries_2020.0.166/linux/compiler/include/,.f90,./.f90,./.f90,../include/.f90,
           ./.f90,/opt/netcdf/4.6.1/INTEL/include/.f90,/opt/intel/2020/compilers_and_libraries/linux/mpi/intel64/include/.f90,
           /opt/intel/2020/compilers_and_libraries/linux/mpi/intel64/include/.f90,/opt/intel/2020/compilers_and_libraries/linux/ipp/include/.f90,
           /opt/intel/2020/compilers_and_libraries/linux/mkl/include/.f90,/opt/intel/2020/compilers_and_libraries/linux/pstl/include/.f90,
           /opt/intel/2020/compilers_and_libraries/linux/tbb/include/.f90,/opt/intel/2020/compilers_and_libraries/linux/daal/include/.f90,
           /opt/intel/2020/compilers_and_libraries_2020.0.166/linux/compiler/include/intel64/.f90,/opt/intel/2020/compilers_and_libraries_2020.0.166/linux/compiler/include/icc/.f90,
           /opt/intel/2020/compilers_and_libraries_2020.0.166/linux/compiler/include/.f90,/usr/local/include/.f90,
           /usr/lib/gcc/x86_64-redhat-linux/4.8.5/include/.f90,/usr/include/.f90,/usr/include/.f90,/usr/include/.f90
       -list filename : horiz_interp_spherical.lst
  no   -o

COMPILER: Intel(R) Fortran 19.1-1555
